<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Programa√ß√£o Semanal</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* Bloqueia a rolagem global da janela para criar um layout de app moderno */
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar: Fixa √† esquerda, ocupando 100% da altura */
        #painelSidebar { display: none; width: 250px; background-color: #fff; border-right: 1px solid #ddd; flex-direction: column; height: 100vh; box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 10;}
        
        /* Painel Principal: Ocupa o resto do espa√ßo (flex: 1) e tem rolagem pr√≥pria (overflow-y: auto) */
        #painelSistema { display: none; flex: 1; overflow-y: auto; padding: 20px; box-sizing: border-box; height: 100vh; position: relative; }
        
        /* Sidebar Elements */
        .sidebar-header { padding: 20px; background-color: #1a73e8; color: white; text-align: center; }
        .sidebar-header h2 { margin: 0; font-size: 18px; }
        #btnNovaProgramacao { background-color: #34a853; color: white; border: none; padding: 10px; margin: 15px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px; }
        #btnNovaProgramacao:hover { background-color: #2b803e; }
        .history-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .history-item { padding: 12px 20px; border-bottom: 1px solid #eee; cursor: pointer; color: #333; font-weight: bold; display: flex; justify-content: space-between; align-items: center;}
        .history-item:hover { background-color: #f1f3f4; color: #1a73e8; }
        .history-item.active { background-color: #e8f0fe; color: #1a73e8; border-left: 4px solid #1a73e8; }
        .btn-delete-history { background: none; border: none; cursor: pointer; color: #ea4335; font-size: 14px; padding: 0 5px;}
        .btn-delete-history:hover { color: #c5221f; transform: scale(1.2);}
        .history-item-actions { display: flex; align-items: center; gap: 5px; }
        
        /* Formul√°rio & Se√ß√µes */
        .container { max-width: 850px; margin: 0 auto; padding-bottom: 40px;}
        .topo-acoes { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        .btn-config { background-color: #fbbc05; color: #333; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;}
        .btn-config:hover { background-color: #f2a600; }
        .btn-sair { background-color: #ea4335; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 14px;}
        .btn-sair:hover { background-color: #c5221f; }
        
        .section { background-color: white; border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);}
        h1 { color: #1a73e8; text-align: center; margin-top: 0;}
        h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 0; display: flex; justify-content: space-between; align-items: center;}
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #444;}
        input, select { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;}
        .input-group { display: flex; gap: 10px; margin-top: 5px; align-items: center;}
        .input-group input, .input-group select { width: 100%; } /* Ajustado para flexibilidade */
        
        button.btn-salvar { background-color: #1a73e8; color: white; padding: 12px 20px; border: none; cursor: pointer; font-size: 16px; margin-top: 15px; border-radius: 4px; width: 100%; font-weight: bold;}
        button.btn-salvar:hover { background-color: #1557b0; }
        
        .btn-add { background-color: #34a853; color: white; width: auto; padding: 6px 12px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer;}
        .btn-add:hover { background-color: #2b803e; }
        .btn-remove { background-color: #ea4335; color: white; width: auto; padding: 10px; margin-top: 0; font-size: 14px; border: none; border-radius: 4px; cursor: pointer;}
        .btn-remove:hover { background-color: #c5221f; }
        
        #mensagem, #loginMensagem { margin-top: 15px; font-weight: bold; text-align: center; }
        
        .dinamico-item { background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px dashed #ccc;}
        .hidden { display: none !important; }
        .evento-destaque { background-color: #e8f0fe; border-color: #d2e3fc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid;}
        
        /* Tela de Login Centralizada */
        #telaLogin { max-width: 400px; margin: auto; text-align: center; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 100%;}
        
        /* Modais */
        .modal-bg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center;}
        .modal-content { background-color: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative;}
        .modal-close { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; color: #666; font-weight: bold;}
        .config-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 15px;}
        .lista-manager { border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #fafafa;}
        .lista-manager select { height: 100px; margin-bottom: 10px;}
        
        /* A√ß√µes do Card de Designa√ß√£o */
        .designacao-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; background-color: #f9f9f9;}
        .btn-whatsapp { background-color: #25D366; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 8px;}
        .btn-whatsapp:hover { background-color: #128C7E; }
        .btn-download-img { background-color: #1a73e8; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 8px;}
        .btn-download-img:hover { background-color: #1557b0; }

        /* Molde Oculto S-89 para gerar a Imagem */
        #molde-s89 {
            position: absolute; left: -9999px; top: -9999px; /* Oculto fora da tela */
            width: 480px; background-color: white; padding: 30px; 
            font-family: Arial, sans-serif; color: black; z-index: -1;
            border: 2px solid #fff; /* Evita bordas cortadas na gera√ß√£o */
        }
        .s89-titulo { text-align: center; font-weight: 900; font-size: 18px; text-transform: uppercase; margin-bottom: 30px; line-height: 1.3; }
        .s89-linha { display: flex; align-items: flex-end; margin-bottom: 15px; font-size: 18px;}
        .s89-label { font-weight: bold; margin-right: 8px; white-space: nowrap; }
        .s89-campo { flex-grow: 1; border-bottom: 2px dotted #000; font-family: 'Courier New', Courier, monospace; font-weight: bold; padding-left: 10px;}
        .s89-local-titulo { font-weight: bold; font-size: 18px; margin-top: 25px; margin-bottom: 10px;}
        .s89-checkbox { font-size: 18px; margin-bottom: 5px; display: flex; align-items: center; gap: 10px;}
        .s89-box { width: 16px; height: 16px; border: 2px solid #000; display: inline-block; }
        .s89-box-checked { background-color: #000; }
        .s89-obs { margin-top: 30px; font-size: 13px; text-align: justify; line-height: 1.4; }

        /* Molde Oculto S-140 para gerar a Tabela F√≠sica */
        #molde-s140-container {
            position: absolute; left: -9999px; top: -9999px; /* Oculto fora da tela */
            width: 800px; background-color: white; padding: 40px; 
            font-family: Arial, sans-serif; color: black; z-index: -1;
        }
        .s140-titulo-geral { text-align: center; font-weight: bold; font-size: 18px; text-transform: uppercase; margin-bottom: 20px;}
        .s140-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .s140-table th, .s140-table td { padding: 8px 5px; border-bottom: 1px solid #000; text-align: left; vertical-align: top;}
        .s140-section-header { background-color: #f2f2f2; border-top: 2px solid #000; border-bottom: 2px solid #000; font-weight: bold; text-transform: uppercase;}
        .s140-col-hora { width: 50px; font-weight: bold;}
        .s140-col-tema { width: auto; font-weight: bold;}
        .s140-col-sala { width: 22%; }
        .s140-sub { font-size: 12px; font-weight: normal; font-style: italic; }
        
        /* Cores Oficiais do S-140 */
        .bg-tesouros { background-color: #5b6770 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
        .bg-ministerio { background-color: #d89b00 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
        .bg-vidacrista { background-color: #990000 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
        .s140-section-header td { padding: 4px 8px; border-bottom: 2px solid #000; }
        
    </style>
</head>
<body>

    <div id="molde-s89">
        <div class="s89-titulo">DESIGNA√á√ÉO PARA A REUNI√ÉO<br>NOSSA VIDA E MINIST√âRIO CRIST√ÉO</div>
        <div class="s89-linha"><div class="s89-label">Nome:</div><div class="s89-campo" id="s89-nome"></div></div>
        <div class="s89-linha"><div class="s89-label">Ajudante:</div><div class="s89-campo" id="s89-ajudante"></div></div>
        <div class="s89-linha"><div class="s89-label">Data:</div><div class="s89-campo" id="s89-data"></div></div>
        <div class="s89-linha"><div class="s89-label">N√∫mero da parte:</div><div class="s89-campo" id="s89-parte"></div></div>
        
        <div class="s89-local-titulo">Local:</div>
        <div class="s89-checkbox"><div class="s89-box s89-box-checked"></div> Sal√£o principal</div>
        <div class="s89-checkbox"><div class="s89-box"></div> Sala B</div>
        <div class="s89-checkbox"><div class="s89-box"></div> Sala C</div>
        
        <div class="s89-obs">
            <strong>Observa√ß√£o para o estudante:</strong> A li√ß√£o e a fonte de mat√©ria para a sua designa√ß√£o est√£o na <i>Apostila da Reuni√£o Vida e Minist√©rio</i>. Veja as instru√ß√µes para a parte que est√£o nas <i>Instru√ß√µes para a Reuni√£o Nossa Vida e Minist√©rio Crist√£o</i> (S-89).
        </div>
    </div>

    <div id="molde-s140-container"></div>

    <div id="telaLogin">
        <h2 style="color: #1a73e8; margin-top: 0;">Acesso Restrito</h2>
        <p style="color: #666; font-size: 14px;">Insira suas credenciais para gerenciar a escala.</p>
        <input type="email" id="emailLogin" placeholder="Seu E-mail" required>
        <input type="password" id="senhaLogin" placeholder="Sua Senha" required>
        <button class="btn-salvar" id="btnEntrar">Entrar no Sistema</button>
        <div id="loginMensagem"></div>
    </div>

    <div id="painelSidebar">
        <div class="sidebar-header">
            <h2>Gestor Semanal</h2>
        </div>
        <button id="btnNovaProgramacao">+ Nova Programa√ß√£o</button>
        <ul class="history-list" id="listaHistorico"></ul>
    </div>

    <div id="painelSistema">
        <div class="container">
            <div class="topo-acoes">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" id="btnConfig" class="btn-config">‚öôÔ∏è Configura√ß√µes</button>
                    <button type="button" id="btnGerarDesignacoes" class="btn-config" style="background-color: #25D366; color: white;">üì± S-89 / WhatsApp</button>
                    <button type="button" id="btnGerarS140" class="btn-config" style="background-color: #9c27b0; color: white;">üñ®Ô∏è Gerar Quadro S-140</button>
                </div>
                <button type="button" id="btnSair" class="btn-sair">Sair do Sistema</button>
            </div>
            
            <h1 id="tituloAcao">Nova Programa√ß√£o</h1>
            
            <form id="formReuniao">
                <div class="evento-destaque">
                    <label for="dataReuniao" style="margin-top: 0;">Data da Reuni√£o:</label>
                    <input type="date" id="dataReuniao" required>
                    
                    <label for="tipoEvento">Tipo de Programa√ß√£o:</label>
                    <select id="tipoEvento">
                        <option value="Normal">Reuni√£o Normal</option>
                        <option value="Visita">Visita do Superintendente de Circuito</option>
                        <option value="Assembleia">Assembleia</option>
                        <option value="Congresso">Congresso</option>
                        <option value="Celebracao">Celebra√ß√£o da Morte de Cristo</option>
                    </select>

                    <label style="display: flex; align-items: center; gap: 10px; margin-top: 15px; cursor: pointer;">
                        <input type="checkbox" id="usarSalaB" style="width: auto; margin: 0; transform: scale(1.3);">
                        <span style="color: #1a73e8; font-weight: bold;">Habilitar uso da Sala B nesta reuni√£o</span>
                    </label>
                </div>

                <div id="formSections">
                    <div class="section">
                        <label for="presidente" style="margin-top: 0;">Presidente da Reuni√£o e Conselheiro (Sala B):</label>
                        <div class="input-group">
                            <select id="presidente" class="lista-presidentes" style="width: 50%;"></select>
                            <select id="conselheiroSalaB" class="aprovados-ensino" style="width: 50%;"></select>
                        </div>
                        <small style="color: #666;">O Conselheiro da Sala B s√≥ ser√° impresso no quadro se a Sala B estiver habilitada acima.</small>
                    </div>

                    <div class="section">
                        <h3>Abertura</h3>
                        <div class="input-group">
                            <input type="number" id="canticoInicial" placeholder="N¬∫ do C√¢ntico Inicial" min="1" style="width: 30%;">
                            <select id="oracaoInicial" class="lista-oracao" style="width: 70%;"></select>
                        </div>
                        <label for="comentariosIniciais">Coment√°rios Iniciais (1 min):</label>
                        <input type="text" id="comentariosIniciais" readonly style="background-color: #e9ecef;">
                    </div>

                    <div class="section">
                        <h3>Tesouros da Palavra de Deus</h3>
                        
                        <label style="color: #45818e;">Leitura Semanal da B√≠blia (Congrega√ß√£o):</label>
                        <input type="text" id="leituraSemanal" placeholder="Ex: ISA√çAS 38-40" style="margin-bottom: 15px; border-color: #45818e; font-weight: bold;">
                        
                        <label>Parte 1 - Discurso Principal (10 min):</label>
                        <div class="input-group">
                            <input type="text" id="temaParte1" placeholder="Tema do Discurso" style="width: 60%;">
                            <select id="parte1" class="aprovados-ensino" style="width: 40%;"></select>
                        </div>
                        
                        <label>Parte 2 - Joias Espirituais (10 min):</label>
                        <div class="input-group">
                            <input type="text" id="temaParte2" placeholder="Tema das Joias" style="width: 60%;">
                            <select id="parte2" class="aprovados-ensino" style="width: 40%;"></select>
                        </div>
                        
                        <label>Parte 3 - Leitura da B√≠blia (Estudante - 4 min):</label>
                        <div class="input-group">
                            <input type="text" id="trechoLeitura" placeholder="Ex: Isa. 40:21-31 (th li√ß√£o 11)" style="width: 60%;">
                            <select id="leituraBiblia" class="lista-irmaos" style="width: 40%;"></select>
                        </div>
                    </div>

                    <div class="section">
                        <h3>
                            Fa√ßa seu Melhor no Minist√©rio
                            <button type="button" class="btn-add" id="btnAddMinisterio">+ Adicionar Parte</button>
                        </h3>
                        <div id="containerMinisterio"></div>
                    </div>

                    <div class="section">
                        <h3>
                            Nossa Vida Crist√£
                            <button type="button" class="btn-add" id="btnAddVidaCrista">+ Adicionar Parte</button>
                        </h3>
                        <label for="canticoIntermediario">C√¢ntico Intermedi√°rio:</label>
                        <input type="number" id="canticoIntermediario" placeholder="N¬∫ do C√¢ntico" min="1">

                        <div id="containerVidaCrista"></div>

                        <div id="blocoEstudo">
                            <label>Estudo B√≠blico de Congrega√ß√£o (30 min):</label>
                            <div class="input-group">
                                <select id="estudoDirigente" class="aprovados-ensino"></select>
                                <select id="estudoLeitor" class="lista-leitores"></select>
                            </div>
                        </div>

                        <div id="blocoVisita" class="hidden">
                            <label style="color: #1a73e8;">Discurso do Superintendente (30 min):</label>
                            <input type="text" id="discursoViajante" placeholder="Nome do Superintendente">
                        </div>

                        <label for="comentariosFinais">Coment√°rios Finais (3 min):</label>
                        <input type="text" id="comentariosFinais" readonly style="background-color: #e9ecef;">

                        <label>Conclus√£o:</label>
                        <div class="input-group">
                            <input type="number" id="canticoFinal" placeholder="N¬∫ do C√¢ntico Final" min="1" style="width: 30%;">
                            <select id="oracaoFinal" class="lista-oracao" style="width: 70%;"></select>
                        </div>
                    </div>
                </div> 

                <button type="button" class="btn-salvar" id="btnSalvar">Salvar Programa√ß√£o</button>
                <div id="mensagem"></div>
            </form>
        </div>
    </div>

    <div id="modalConfig" class="modal-bg">
        <div class="modal-content">
            <span class="modal-close" id="fecharConfig">&times;</span>
            <h2 style="color: #1a73e8; margin-top: 0;">Configura√ß√µes e Listas</h2>
            
            <div class="section" style="padding: 15px; margin-bottom: 10px;">
                <label for="configNomeCongregacao" style="margin-top:0;">Nome da Congrega√ß√£o (Para o S-140):</label>
                <input type="text" id="configNomeCongregacao" placeholder="Ex: CONGREGA√á√ÉO CENTRO">
                
                <label for="configDiaReuniao">Dia da Reuni√£o na Semana:</label>
                <select id="configDiaReuniao">
                    <option value="1">Segunda-feira</option>
                    <option value="2">Ter√ßa-feira</option>
                    <option value="3">Quarta-feira</option>
                    <option value="4">Quinta-feira</option>
                    <option value="5">Sexta-feira</option>
                    <option value="6">S√°bado</option>
                    <option value="0">Domingo</option>
                </select>
            </div>

            <div class="config-grid">
                <div class="lista-manager">
                    <label style="margin-top:0;">Selecione a Lista para Gerenciar:</label>
                    <select id="tipoListaEdicao">
                        <option value="irmaos">Irm√£os (Leitura e Geral)</option>
                        <option value="irmas">Irm√£s (Geral)</option>
                        <option value="presidentes">Aprovados para Presidente</option>
                        <option value="aprovados_ensino">Aprovados para Discursos/Ensino</option>
                        <option value="leitores_estudo">Aprovados para Leitor do Estudo</option>
                        <option value="aprovados_oracao">Aprovados para Ora√ß√£o</option>
                    </select>
                    
                    <select id="listaItensAtuais" multiple></select>
                    <button type="button" class="btn-remove" id="btnRemoverNome" style="width: 100%; margin-bottom: 10px;">Remover Selecionado</button>
                    
                    <div class="input-group">
                        <input type="text" id="novoNome" placeholder="Adicionar novo nome...">
                        <button type="button" class="btn-add" id="btnAdicionarNome" style="padding: 10px;">Adicionar</button>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn-salvar" id="btnSalvarConfig">Salvar Configura√ß√µes</button>
            <div id="msgConfig" style="text-align: center; margin-top: 10px; font-weight: bold;"></div>
        </div>
    </div>

    <div id="modalDesignacoes" class="modal-bg">
        <div class="modal-content">
            <span class="modal-close" id="fecharDesignacoes">&times;</span>
            <h2 style="color: #25D366; margin-top: 0;" id="tituloModalGerar">üì± Designa√ß√µes Geradas</h2>
            
            <div id="loadingImagens" style="text-align: center; padding: 20px; font-weight: bold; color: #1a73e8; display: none;">
                ‚è≥ Processando, por favor aguarde...
            </div>

            <div id="conteudoDesignacoes">
                <button type="button" id="btnBaixarTodasImagens" class="btn-salvar" style="background-color: #fbbc05; color: #333; margin-top: 0; margin-bottom: 20px; display: none;">
                    üì¶ Baixar TODAS as Imagens (Arquivo ZIP)
                </button>
                <div id="listaDesignacoesProntas" style="max-height: 50vh; overflow-y: auto; padding-right: 10px;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC3U8tyPk5IB_y51-3d7_6V-16qtoqzeI8",
            authDomain: "quadro-congregacao.firebaseapp.com",
            projectId: "quadro-congregacao",
            storageBucket: "quadro-congregacao.firebasestorage.app",
            messagingSenderId: "1085145636546",
            appId: "1:1085145636546:web:69d340e69f28814a1de55b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- ESTADO GLOBAL ---
        let configGlobal = {
            nome_congregacao: "SUA CONGREGA√á√ÉO",
            dia_reuniao: 4, 
            aprovados_oracao: ["Edinho Freitas", "Elton Freitas", "Francisco Nunes", "Glebston", "Robert C√©sar", "Rony Henrique"].sort(),
            presidentes: ["Francisco Nunes", "Glebston", "Robert C√©sar"].sort(),
            aprovados_ensino: ["Francisco Nunes", "Glebston", "Robert C√©sar"].sort(),
            leitores_estudo: ["Edinho Freitas", "Elton Freitas", "Glebston", "Nic√°cio", "Robert C√©sar", "Rony Henrique"].sort(),
            irmaos: ["Ant√¥nio Duarte", "Celso Dornellys", "David Gabriel", "Edgl√™", "Edinho Freitas", "Elton Freitas", "Francisco Nunes", "Genival", "Glebston", "Leonel", "Nic√°cio", "Robert C√©sar", "Rony Henrique", "S√°vio Samuel"].sort(),
            irmas: ["Ana Paula", "Anna Clara", "Bruna", "Cleonice", "Concei√ß√£o", "Dona Lia", "Francinete", "Geralda", "Gerl√¢ndia", "Giudeth", "Helena", "Jaiara", "Joelma Sobreira", "Kleitiane", "Leticia Lima", "Let√≠cia Ang√©lica", "Libet√¢nia", "Luci", "Maria Helena", "Mayane", "Rem√©dios", "Sabrina", "Silmara", "Silvia", "Sonilde", "Suelene", "Terezinha", "Vitoria", "V√¢nia", "Zildilene", "Zuilha"].sort()
        };
        let dadosSemanaAnterior = null;
        let designacoesGeradasMemoria = []; 

        // --- L√ìGICA DE AUTENTICA√á√ÉO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('telaLogin').style.display = 'none';
                document.getElementById('painelSidebar').style.display = 'flex';
                document.getElementById('painelSistema').style.display = 'block';
                await carregarConfiguracoes();
                carregarHistoricoSidebar();
                prepararNovoFormulario();
            } else {
                document.getElementById('telaLogin').style.display = 'block';
                document.getElementById('painelSidebar').style.display = 'none';
                document.getElementById('painelSistema').style.display = 'none';
            }
        });

        document.getElementById('btnEntrar').addEventListener('click', async () => {
            const email = document.getElementById('emailLogin').value;
            const senha = document.getElementById('senhaLogin').value;
            document.getElementById('loginMensagem').innerText = "Acessando...";
            try { await signInWithEmailAndPassword(auth, email, senha); } 
            catch (error) { document.getElementById('loginMensagem').innerText = "Erro: Verifique e-mail e senha."; document.getElementById('loginMensagem').style.color = "red"; }
        });

        document.getElementById('btnSair').addEventListener('click', () => signOut(auth));

        // --- BANCO DE DADOS: CONFIGURA√á√ïES GLOBAIS ---
        async function carregarConfiguracoes() {
            try {
                const docSnap = await getDoc(doc(db, "configuracoes", "geral"));
                if (docSnap.exists()) {
                    configGlobal = { ...configGlobal, ...docSnap.data() };
                } else {
                    await setDoc(doc(db, "configuracoes", "geral"), configGlobal);
                }
                
                if (!configGlobal.aprovados_oracao) {
                    configGlobal.aprovados_oracao = ["Edinho Freitas", "Elton Freitas", "Francisco Nunes", "Glebston", "Robert C√©sar", "Rony Henrique"].sort();
                    await setDoc(doc(db, "configuracoes", "geral"), configGlobal);
                }

                atualizarDOMComListas();
            } catch (err) { console.error("Erro ao carregar configura√ß√µes", err); }
        }

        function atualizarDOMComListas() {
            const todos = [...configGlobal.irmaos, ...configGlobal.irmas].sort();
            const gerarOpts = (arr, ph) => `<option value="">${ph}</option>` + arr.map(n => `<option value="${n}">${n}</option>`).join('');
            
            document.querySelectorAll('.lista-presidentes').forEach(s => s.innerHTML = gerarOpts(configGlobal.presidentes, "Selecione o Presidente..."));
            document.querySelectorAll('.aprovados-ensino').forEach(s => s.innerHTML = gerarOpts(configGlobal.aprovados_ensino, "Selecione..."));
            document.querySelectorAll('.lista-leitores').forEach(s => s.innerHTML = gerarOpts(configGlobal.leitores_estudo, "Leitor do Estudo..."));
            document.querySelectorAll('.lista-oracao').forEach(s => s.innerHTML = gerarOpts(configGlobal.aprovados_oracao, "Ora√ß√£o..."));
            document.querySelectorAll('.lista-irmaos').forEach(s => s.innerHTML = gerarOpts(configGlobal.irmaos, "Irm√£o Designado..."));
            
            // Atualiza os din√¢micos sem perder o valor atual
            document.querySelectorAll('.min-estudante, .min-estudante-b').forEach(s => { const v = s.value; s.innerHTML = gerarOpts(todos, "Estudante"); s.value = v; });
            document.querySelectorAll('.min-ajudante, .min-ajudante-b').forEach(s => { const v = s.value; s.innerHTML = gerarOpts(todos, "Ajudante"); s.value = v; });
            document.querySelectorAll('.vc-designado').forEach(s => { const v = s.value; s.innerHTML = gerarOpts(configGlobal.aprovados_ensino, "Designado"); s.value = v; });
            
            document.getElementById('conselheiroSalaB').innerHTML = gerarOpts(configGlobal.aprovados_ensino, "Conselheiro Sala B...");
        }

        // --- CONTROLE DE EXIBI√á√ÉO DA SALA B ---
        document.getElementById('usarSalaB').addEventListener('change', (e) => {
            const display = e.target.checked ? 'flex' : 'none';
            document.querySelectorAll('.sala-b-group').forEach(el => el.style.display = display);
        });

        // --- SIDEBAR E FLUXO DE LIMPEZA ---
        async function carregarHistoricoSidebar() {
            const lista = document.getElementById('listaHistorico');
            lista.innerHTML = '<li class="history-item">Carregando...</li>';
            try {
                const querySnapshot = await getDocs(collection(db, "programacoes_semanais"));
                let datas = [];
                querySnapshot.forEach(doc => datas.push(doc.id));
                datas.sort((a,b) => b.localeCompare(a)); 

                lista.innerHTML = '';
                datas.forEach(d => {
                    const li = document.createElement('li');
                    li.className = 'history-item';
                    
                    const spanData = document.createElement('span');
                    spanData.innerText = d.split('-').reverse().join('/');
                    spanData.style.flex = "1";
                    spanData.onclick = () => carregarProgramacaoEdicao(d, li);

                    const divAcoes = document.createElement('div');
                    divAcoes.className = 'history-item-actions';
                    
                    const btnEditar = document.createElement('span');
                    btnEditar.innerText = '‚úèÔ∏è';
                    btnEditar.style.cursor = 'pointer';
                    btnEditar.onclick = () => carregarProgramacaoEdicao(d, li);

                    const btnExcluir = document.createElement('button');
                    btnExcluir.innerHTML = 'üóëÔ∏è';
                    btnExcluir.className = 'btn-delete-history';
                    btnExcluir.title = "Excluir Reuni√£o";
                    btnExcluir.onclick = async (e) => {
                        e.stopPropagation(); 
                        if(confirm(`‚ö†Ô∏è ATEN√á√ÉO: Tem certeza que deseja EXCLUIR permanentemente a reuni√£o do dia ${spanData.innerText}?`)) {
                            try {
                                await deleteDoc(doc(db, "programacoes_semanais", d));
                                carregarHistoricoSidebar(); 
                                if(document.getElementById('dataReuniao').value === d) prepararNovoFormulario();
                            } catch(err) { alert("Erro ao excluir do banco de dados."); }
                        }
                    };

                    divAcoes.appendChild(btnEditar);
                    divAcoes.appendChild(btnExcluir);
                    
                    li.appendChild(spanData);
                    li.appendChild(divAcoes);
                    lista.appendChild(li);
                });
            } catch(e) { lista.innerHTML = '<li class="history-item">Erro ao carregar</li>'; }
        }

        document.getElementById('btnNovaProgramacao').addEventListener('click', () => {
            document.querySelectorAll('.history-item').forEach(i => i.classList.remove('active'));
            prepararNovoFormulario();
        });

        function prepararNovoFormulario() {
            document.getElementById('formReuniao').reset();
            document.getElementById('usarSalaB').dispatchEvent(new Event('change')); // Reseta visual da sala B
            document.getElementById('tituloAcao').innerText = "Nova Programa√ß√£o";
            document.getElementById('mensagem').innerText = "";
            document.getElementById('formSections').classList.remove('hidden');
            document.getElementById('blocoVisita').classList.add('hidden');
            document.getElementById('blocoEstudo').classList.remove('hidden');
            
            document.getElementById('containerMinisterio').innerHTML = '';
            document.getElementById('containerVidaCrista').innerHTML = '';
            criarParteMinisterio(); criarParteMinisterio(); criarParteMinisterio();
            criarParteVidaCrista();
            
            sugerirProximaData();
        }

       function sugerirProximaData() {
            const ultimaDataSalva = document.querySelector('#listaHistorico .history-item span');
            if (ultimaDataSalva && ultimaDataSalva.innerText.includes('/')) {
                const partes = ultimaDataSalva.innerText.split('/');
                let d = new Date(`${partes[2]}-${partes[1]}-${partes[0]}T12:00:00`);
                d.setDate(d.getDate() + 7);
                document.getElementById('dataReuniao').value = d.toISOString().split('T')[0];
            } else {
                let hoje = new Date();
                let diaAlvo = parseInt(configGlobal.dia_reuniao);
                let offset = (diaAlvo - hoje.getDay() + 7) % 7;
                if (offset === 0) offset = 7; 
                let prox = new Date(hoje);
                prox.setDate(hoje.getDate() + offset);
                document.getElementById('dataReuniao').value = prox.toISOString().split('T')[0];
            }
            buscarDadosSemanaAnterior(document.getElementById('dataReuniao').value);
        }

        document.getElementById('tipoEvento').addEventListener('change', (e) => {
            const val = e.target.value;
            const formSections = document.getElementById('formSections');
            if (["Assembleia", "Congresso", "Celebracao"].includes(val)) {
                formSections.classList.add('hidden');
            } else {
                formSections.classList.remove('hidden');
                if (val === "Visita") {
                    document.getElementById('blocoEstudo').classList.add('hidden');
                    document.getElementById('blocoVisita').classList.remove('hidden');
                } else {
                    document.getElementById('blocoEstudo').classList.remove('hidden');
                    document.getElementById('blocoVisita').classList.add('hidden');
                }
            }
        });

        document.getElementById('presidente').addEventListener('change', (e) => {
            document.getElementById('comentariosIniciais').value = e.target.value;
            document.getElementById('comentariosFinais').value = e.target.value;
        });

       // --- VALIDA√á√ÉO ANTI-DUPLICIDADE (ATUALIZADA PARA SALA B) ---
        document.getElementById('formSections').addEventListener('change', (e) => {
            if (e.target.tagName !== 'SELECT') return;
            const selecionado = e.target.value;
            if (!selecionado) return;

            const isEstudante = e.target.classList.contains('min-estudante') || e.target.classList.contains('min-estudante-b');
            const isAjudante = e.target.classList.contains('min-ajudante') || e.target.classList.contains('min-ajudante-b');
            const isLeitura = e.target.id === 'leituraBiblia';

            if (!isEstudante && !isAjudante && !isLeitura) return;

            if (isEstudante || isAjudante) {
                const selects = document.querySelectorAll('#containerMinisterio select');
                let contagem = 0;
                selects.forEach(s => { if(s.value === selecionado) contagem++; });

                if(contagem > 1) {
                    alert(`‚ö†Ô∏è TRAVA DE SEGURAN√áA:\n\nO(a) publicador(a) "${selecionado}" j√° foi selecionado(a) para outra parte (ou sala) nesta MESMA reuni√£o.`);
                    e.target.value = ""; 
                    return; 
                }
            }

            if (dadosSemanaAnterior) {
                let func = null;
                if (isLeitura && dadosSemanaAnterior.tesouros && dadosSemanaAnterior.tesouros.leitura === selecionado) {
                    func = "LEITOR DA B√çBLIA";
                } 
                else if ((isEstudante || isAjudante) && dadosSemanaAnterior.ministerio) {
                    dadosSemanaAnterior.ministerio.forEach(p => {
                        if (isAjudante && (p.ajudante === selecionado || p.ajudante_b === selecionado)) func = "AJUDANTE";
                        if (isEstudante && (p.estudante === selecionado || p.estudante_b === selecionado)) func = "ESTUDANTE";
                    });
                }
                
                if (func) {
                    alert(`‚ö†Ô∏è AVISO INTELIGENTE:\n\nO(a) publicador(a) "${selecionado}" j√° participou como ${func} na semana passada.\n\n`);
                }
            }
        });

        async function buscarDadosSemanaAnterior(dataAtualStr) {
            if(!dataAtualStr) return;
            const d = new Date(dataAtualStr + "T12:00:00"); 
            d.setDate(d.getDate() - 7);
            try {
                const docSnap = await getDoc(doc(db, "programacoes_semanais", d.toISOString().split('T')[0]));
                dadosSemanaAnterior = docSnap.exists() ? docSnap.data() : null;
            } catch(err) { dadosSemanaAnterior = null; }
        }
        document.getElementById('dataReuniao').addEventListener('change', (e) => buscarDadosSemanaAnterior(e.target.value));

        // --- PARTES DIN√ÇMICAS (ATUALIZADO COM TEMAS E SALA B) ---
        function criarParteMinisterio(tema="", tempo="", est="", aju="", estB="", ajuB="") {
            const todos = [...configGlobal.irmaos, ...configGlobal.irmas].sort();
            const gerarOpts = (arr, ph, sel) => `<option value="">${ph}</option>` + arr.map(n => `<option value="${n}" ${n===sel?'selected':''}>${n}</option>`).join('');
            
            const displaySalaB = document.getElementById('usarSalaB').checked ? 'flex' : 'none';

            const div = document.createElement('div');
            div.className = 'dinamico-item';
            div.style.display = 'flex'; div.style.flexDirection = 'column'; div.style.gap = '5px';
            div.innerHTML = `
                <div class="input-group">
                    <input type="text" class="min-tema" placeholder="Tema da Parte" style="width: 60%; font-weight: bold;" value="${tema}">
                    <input type="number" class="min-tempo" placeholder="Min" style="width: 20%;" value="${tempo}">
                    <button type="button" class="btn-remove" style="width: 20%;" onclick="this.parentElement.parentElement.remove()">X</button>
                </div>
                <div class="input-group">
                    <select class="min-estudante" style="width: 50%;">${gerarOpts(todos, "Principal: Estudante", est)}</select>
                    <select class="min-ajudante" style="width: 50%;">${gerarOpts(todos, "Principal: Ajudante", aju)}</select>
                </div>
                <div class="input-group sala-b-group" style="display: ${displaySalaB}; margin-top: 5px; border-top: 1px dashed #ccc; padding-top: 5px;">
                    <select class="min-estudante-b" style="width: 50%; border-color: #1a73e8;">${gerarOpts(todos, "Sala B: Estudante", estB)}</select>
                    <select class="min-ajudante-b" style="width: 50%; border-color: #1a73e8;">${gerarOpts(todos, "Sala B: Ajudante", ajuB)}</select>
                </div>
            `;
            document.getElementById('containerMinisterio').appendChild(div);
        }

        function criarParteVidaCrista(tema="", tmp="", des="") {
            const gerarOpts = (arr, ph, sel) => `<option value="">${ph}</option>` + arr.map(n => `<option value="${n}" ${n===sel?'selected':''}>${n}</option>`).join('');
            
            const div = document.createElement('div');
            div.className = 'dinamico-item';
            div.style.display = 'flex'; div.style.flexDirection = 'column'; div.style.gap = '5px';
            div.innerHTML = `
                <div class="input-group">
                    <input type="text" class="vc-tema" placeholder="Tema da Parte" style="width: 60%; font-weight: bold;" value="${tema}">
                    <input type="number" class="vc-tempo" placeholder="Min" style="width: 20%;" value="${tmp}">
                    <button type="button" class="btn-remove" style="width: 20%;" onclick="this.parentElement.parentElement.remove()">X</button>
                </div>
                <select class="vc-designado aprovados-ensino" style="width: 100%;">${gerarOpts(configGlobal.aprovados_ensino, "Designado do Sal√£o Principal", des)}</select>
            `;
            document.getElementById('containerVidaCrista').appendChild(div);
        }
        document.getElementById('btnAddMinisterio').addEventListener('click', () => criarParteMinisterio());
        document.getElementById('btnAddVidaCrista').addEventListener('click', () => criarParteVidaCrista());

        // --- EDI√á√ÉO (RETROCOMPAT√çVEL) ---
        async function carregarProgramacaoEdicao(dataId, liElement) {
            document.querySelectorAll('.history-item').forEach(i => i.classList.remove('active'));
            liElement.classList.add('active');
            document.getElementById('mensagem').innerText = "Carregando dados...";
            
            try {
                const docSnap = await getDoc(doc(db, "programacoes_semanais", dataId));
                if(docSnap.exists()) {
                    const d = docSnap.data();
                    document.getElementById('tituloAcao').innerText = `Editando: ${dataId.split('-').reverse().join('/')}`;
                    document.getElementById('dataReuniao').value = d.data;
                    document.getElementById('tipoEvento').value = d.tipo_evento || "Normal";
                    document.getElementById('tipoEvento').dispatchEvent(new Event('change')); 

                    document.getElementById('usarSalaB').checked = d.usar_sala_b || false;
                    document.getElementById('usarSalaB').dispatchEvent(new Event('change'));
                    
                    if (!["Assembleia", "Congresso", "Celebracao"].includes(d.tipo_evento)) {
                        document.getElementById('presidente').value = d.presidente || "";
                        document.getElementById('conselheiroSalaB').value = d.conselheiro_sala_b || "";
                        document.getElementById('presidente').dispatchEvent(new Event('change'));
                        
                        document.getElementById('canticoInicial').value = d.abertura?.cantico || "";
                        document.getElementById('oracaoInicial').value = d.abertura?.oracao || "";
                        
                        document.getElementById('temaParte1').value = d.tesouros?.tema_1 || "";
                        document.getElementById('parte1').value = d.tesouros?.parte_1 || "";
                        document.getElementById('temaParte2').value = d.tesouros?.tema_2 || "";
                        document.getElementById('parte2').value = d.tesouros?.parte_2 || "";
                        
                        document.getElementById('leituraSemanal').value = d.tesouros?.leitura_semanal || "";
                        document.getElementById('trechoLeitura').value = d.tesouros?.trecho_leitura || "";
                        document.getElementById('leituraBiblia').value = d.tesouros?.leitura || "";
                        
                        document.getElementById('containerMinisterio').innerHTML = '';
                        if(d.ministerio) d.ministerio.forEach(p => criarParteMinisterio(p.tema, p.tempo, p.estudante, p.ajudante, p.estudante_b, p.ajudante_b));
                        
                        document.getElementById('canticoIntermediario').value = d.vida_crista?.cantico_intermediario || "";
                        document.getElementById('containerVidaCrista').innerHTML = '';
                        if(d.vida_crista?.partes) d.vida_crista.partes.forEach(p => criarParteVidaCrista(p.tema, p.tempo, p.designado));
                        
                        document.getElementById('estudoDirigente').value = d.vida_crista?.estudo_dirigente || "";
                        document.getElementById('estudoLeitor').value = d.vida_crista?.estudo_leitor || "";
                        document.getElementById('discursoViajante').value = d.vida_crista?.discurso_viajante || "";
                        
                        document.getElementById('canticoFinal').value = d.vida_crista?.cantico_final || "";
                        document.getElementById('oracaoFinal').value = d.vida_crista?.oracao_final || "";
                    }
                    document.getElementById('mensagem').innerText = "";
                }
            } catch(e) { document.getElementById('mensagem').innerText = "Erro ao carregar edi√ß√£o."; }
        }

        // --- SALVAMENTO ---
        document.getElementById('btnSalvar').addEventListener('click', async () => {
            const dataReuniao = document.getElementById('dataReuniao').value;
            const tipoEvento = document.getElementById('tipoEvento').value;
            const msgDiv = document.getElementById('mensagem');

            if (!dataReuniao) { msgDiv.style.color = "red"; msgDiv.innerText = "ATEN√á√ÉO: Selecione a data."; return; }
            msgDiv.style.color = "blue"; msgDiv.innerText = "Salvando no banco de dados...";

            let programacaoData = { 
                data: dataReuniao, 
                tipo_evento: tipoEvento,
                usar_sala_b: document.getElementById('usarSalaB').checked 
            };

            if (!["Assembleia", "Congresso", "Celebracao"].includes(tipoEvento)) {
                const min = [], vc = [];
                document.querySelectorAll('#containerMinisterio .dinamico-item').forEach(i => {
                    min.push({
                        tema: i.querySelector('.min-tema').value, tempo: i.querySelector('.min-tempo').value,
                        estudante: i.querySelector('.min-estudante').value, ajudante: i.querySelector('.min-ajudante').value,
                        estudante_b: i.querySelector('.min-estudante-b').value, ajudante_b: i.querySelector('.min-ajudante-b').value
                    });
                });
                
                document.querySelectorAll('#containerVidaCrista .dinamico-item').forEach(i => {
                    vc.push({
                        tema: i.querySelector('.vc-tema').value, tempo: i.querySelector('.vc-tempo').value, 
                        designado: i.querySelector('.vc-designado').value
                    });
                });
                
                programacaoData = { ...programacaoData,
                    presidente: document.getElementById('presidente').value,
                    conselheiro_sala_b: document.getElementById('conselheiroSalaB').value,
                    abertura: { cantico: document.getElementById('canticoInicial').value, oracao: document.getElementById('oracaoInicial').value, comentarios: document.getElementById('comentariosIniciais').value },
                   tesouros: { 
                        tema_1: document.getElementById('temaParte1').value, parte_1: document.getElementById('parte1').value, 
                        tema_2: document.getElementById('temaParte2').value, parte_2: document.getElementById('parte2').value, 
                        leitura_semanal: document.getElementById('leituraSemanal').value, 
                        trecho_leitura: document.getElementById('trechoLeitura').value, 
                        leitura: document.getElementById('leituraBiblia').value 
                    },
                    ministerio: min,
                    vida_crista: {
                        cantico_intermediario: document.getElementById('canticoIntermediario').value, partes: vc,
                        estudo_dirigente: document.getElementById('estudoDirigente').value, estudo_leitor: document.getElementById('estudoLeitor').value,
                        discurso_viajante: document.getElementById('discursoViajante').value, comentarios_finais: document.getElementById('comentariosFinais').value,
                        cantico_final: document.getElementById('canticoFinal').value, oracao_final: document.getElementById('oracaoFinal').value
                    }
                };
            }

            try {
                await setDoc(doc(db, "programacoes_semanais", dataReuniao), programacaoData);
                msgDiv.style.color = "green"; msgDiv.innerText = "Salvo com sucesso!";
                carregarHistoricoSidebar();
                setTimeout(() => { prepararNovoFormulario(); }, 1500);
            } catch (error) { msgDiv.style.color = "red"; msgDiv.innerText = "Erro ao salvar."; }
        });

        // --- MODAL CONFIGURA√á√ïES ---
        const modalConfig = document.getElementById('modalConfig');
        const selectListaAtiva = document.getElementById('tipoListaEdicao');
        const boxItens = document.getElementById('listaItensAtuais');

        document.getElementById('btnConfig').addEventListener('click', () => {
            document.getElementById('configDiaReuniao').value = configGlobal.dia_reuniao;
            document.getElementById('configNomeCongregacao').value = configGlobal.nome_congregacao || "";
            renderizarListaConfig();
            modalConfig.style.display = 'flex';
        });
        
        document.getElementById('fecharConfig').addEventListener('click', () => modalConfig.style.display = 'none');
        selectListaAtiva.addEventListener('change', renderizarListaConfig);

        function renderizarListaConfig() {
            const tipo = selectListaAtiva.value;
            boxItens.innerHTML = '';
            const arrayAtual = configGlobal[tipo] || [];
            arrayAtual.forEach(nome => {
                const opt = document.createElement('option');
                opt.value = nome; opt.innerText = nome;
                boxItens.appendChild(opt);
            });
        }

        document.getElementById('btnAdicionarNome').addEventListener('click', () => {
            const input = document.getElementById('novoNome');
            const tipo = selectListaAtiva.value;
            const nomeStr = input.value.trim();
            if(!nomeStr) return;
            const nomes = nomeStr.split(',').map(n => n.trim()).filter(n => n);
            nomes.forEach(n => { if(!configGlobal[tipo].includes(n)) configGlobal[tipo].push(n); });
            configGlobal[tipo].sort(); input.value = ''; renderizarListaConfig();
        });

        document.getElementById('btnRemoverNome').addEventListener('click', () => {
            const tipo = selectListaAtiva.value;
            const selecionados = Array.from(boxItens.selectedOptions).map(o => o.value);
            configGlobal[tipo] = configGlobal[tipo].filter(n => !selecionados.includes(n));
            renderizarListaConfig();
        });

        document.getElementById('btnSalvarConfig').addEventListener('click', async () => {
            const msg = document.getElementById('msgConfig');
            msg.style.color = "blue"; msg.innerText = "Salvando configura√ß√µes...";
            configGlobal.dia_reuniao = parseInt(document.getElementById('configDiaReuniao').value);
            configGlobal.nome_congregacao = document.getElementById('configNomeCongregacao').value.toUpperCase();
            try {
                await setDoc(doc(db, "configuracoes", "geral"), configGlobal);
                atualizarDOMComListas();
                msg.style.color = "green"; msg.innerText = "Configura√ß√µes salvas!";
                setTimeout(() => { modalConfig.style.display = 'none'; msg.innerText=""; }, 1500);
            } catch(e) { msg.style.color = "red"; msg.innerText = "Erro ao salvar."; }
        });

        // --- GERA√á√ÉO QUADRO S-140 (O NOVO MOTOR F√çSICO) ---
        document.getElementById('btnGerarS140').addEventListener('click', async () => {
            const dataReuniao = document.getElementById('dataReuniao').value;
            if (!dataReuniao) { alert("Selecione uma data antes de gerar o quadro."); return; }
            
            // Trava de seguran√ßa: garantir que foi salvo antes de gerar
            const msgDiv = document.getElementById('mensagem');
            msgDiv.style.color = "blue"; msgDiv.innerText = "Gerando Quadro S-140...";

            const usarSalaB = document.getElementById('usarSalaB').checked;
            const dataBR = dataReuniao.split('-').reverse().join('/');
            const nomeCong = configGlobal.nome_congregacao || "CONGREGA√á√ÉO";

            const container = document.getElementById('molde-s140-container');
            
            // Montagem din√¢mica do HTML do S-140 (Sem a coluna de hor√°rios)
            const colunasHeader = usarSalaB 
                ? `<th class="s140-col-sala">Sala B</th><th class="s140-col-sala">Sal√£o principal</th>` 
                : `<th class="s140-col-sala" colspan="2">Sal√£o principal</th>`;

            const txtAju = (aju) => aju ? `<br><span class="s140-sub">Aj: ${aju}</span>` : "";
            const formataMin = (tema, tmp) => `${tema || "---"} ${tmp ? `(${tmp} min)` : ""}`;
            
            // Extraindo Minist√©rio din√¢mico
            let minHTML = '';
            document.querySelectorAll('#containerMinisterio .dinamico-item').forEach((item, index) => {
                const tema = formataMin(item.querySelector('.min-tema').value, item.querySelector('.min-tempo').value);
                const estAjuP = `Est: ${item.querySelector('.min-estudante').value || "---"}${txtAju(item.querySelector('.min-ajudante').value)}`;
                const estAjuB = usarSalaB ? `Est: ${item.querySelector('.min-estudante-b').value || "---"}${txtAju(item.querySelector('.min-ajudante-b').value)}` : "";
                
                minHTML += `
                <tr>
                    <td class="s140-col-tema">${index + 4}. ${tema}</td>
                    ${usarSalaB ? `<td>${estAjuB}</td>` : ''}
                    <td ${usarSalaB ? '' : 'colspan="2"'}>${estAjuP}</td>
                </tr>`;
            });

            // Extraindo Vida Crist√£ din√¢mica
            let vcHTML = '';
            document.querySelectorAll('#containerVidaCrista .dinamico-item').forEach((item, index) => {
                const tema = formataMin(item.querySelector('.vc-tema').value, item.querySelector('.vc-tempo').value);
                vcHTML += `
                <tr>
                    <td class="s140-col-tema" ${usarSalaB ? 'colspan="2"' : ''}>${index + 7}. ${tema}</td>
                    <td ${usarSalaB ? '' : 'colspan="2"'}>${item.querySelector('.vc-designado').value || "---"}</td>
                </tr>`;
            });

            // Conselheiro Sala B header fix
            const conselheiroRow = usarSalaB 
                ? `<tr><td style="border:none;"></td><td colspan="2" style="border:none; text-align:right; padding-bottom:10px;">Conselheiro da sala B: <strong>${document.getElementById('conselheiroSalaB').value || "---"}</strong></td></tr>`
                : '';

            const leituraSemanalStr = document.getElementById('leituraSemanal').value || "---";
            const trechoLeituraStr = document.getElementById('trechoLeitura').value || "";

            container.innerHTML = `
                <div class="s140-titulo-geral">${nomeCong}<br>Programa√ß√£o da reuni√£o do meio de semana</div>
                <table class="s140-table">
                    <tr>
                        <td colspan="2" style="border:none; font-weight:bold; padding-bottom:10px;">${dataBR} | LEITURA SEMANAL DA B√çBLIA: ${leituraSemanalStr}</td>
                        <td style="border:none; text-align:right; padding-bottom:10px;">Presidente: <strong>${document.getElementById('presidente').value || "---"}</strong></td>
                    </tr>
                    ${conselheiroRow}
                    <tr>
                        <td class="s140-col-tema" colspan="2">C√¢ntico ${document.getElementById('canticoInicial').value || "---"} e Ora√ß√£o</td>
                        <td>${document.getElementById('oracaoInicial').value || "---"}</td>
                    </tr>
                    <tr>
                        <td class="s140-col-tema" colspan="3">Coment√°rios iniciais (1 min)</td>
                    </tr>
                    
                    <tr class="s140-section-header bg-tesouros">
                        <td>TESOUROS DA PALAVRA DE DEUS</td>
                        ${colunasHeader}
                    </tr>
                    <tr>
                        <td class="s140-col-tema" ${usarSalaB ? 'colspan="2"' : ''}>1. ${document.getElementById('temaParte1').value || "---"} (10 min)</td>
                        <td ${usarSalaB ? '' : 'colspan="2"'}>${document.getElementById('parte1').value || "---"}</td>
                    </tr>
                    <tr>
                        <td class="s140-col-tema" ${usarSalaB ? 'colspan="2"' : ''}>2. ${document.getElementById('temaParte2').value || "---"} (10 min)</td>
                        <td ${usarSalaB ? '' : 'colspan="2"'}>${document.getElementById('parte2').value || "---"}</td>
                    </tr>
                    <tr>
                        <td class="s140-col-tema">3. Leitura da B√≠blia (4 min) <span style="font-weight: normal;">${trechoLeituraStr}</span></td>
                        ${usarSalaB ? `<td>---</td>` : ''}
                        <td ${usarSalaB ? '' : 'colspan="2"'}>Est: ${document.getElementById('leituraBiblia').value || "---"}</td>
                    </tr>

                    <tr class="s140-section-header bg-ministerio">
                        <td>FA√áA SEU MELHOR NO MINIST√âRIO</td>
                        ${colunasHeader}
                    </tr>
                    ${minHTML}

                    <tr class="s140-section-header bg-vidacrista">
                        <td colspan="3">NOSSA VIDA CRIST√É</td>
                    </tr>
                    <tr>
                        <td class="s140-col-tema" colspan="3">C√¢ntico ${document.getElementById('canticoIntermediario').value || "---"}</td>
                    </tr>
                    ${vcHTML}
                    <tr>
                        <td class="s140-col-tema" ${usarSalaB ? 'colspan="2"' : ''}>Estudo b√≠blico de congrega√ß√£o (30 min)</td>
                        <td ${usarSalaB ? '' : 'colspan="2"'}>Dir: ${document.getElementById('estudoDirigente').value || "---"}<br><span class="s140-sub">Lei: ${document.getElementById('estudoLeitor').value || "---"}</span></td>
                    </tr>
                    <tr>
                        <td class="s140-col-tema" colspan="3">Coment√°rios finais (3 min)</td>
                    </tr>
                    <tr>
                        <td class="s140-col-tema" colspan="2">C√¢ntico ${document.getElementById('canticoFinal').value || "---"} e Ora√ß√£o</td>
                        <td>${document.getElementById('oracaoFinal').value || "---"}</td>
                    </tr>
                </table>
            `;
            
            try {
                const canvas = await html2canvas(container, { scale: 2, backgroundColor: "#ffffff" });
                const imgDataUrl = canvas.toDataURL('image/png');
                saveAs(imgDataUrl, `S140_Quadro_${dataReuniao}.png`);
                msgDiv.style.color = "green"; msgDiv.innerText = "Quadro S-140 baixado com sucesso!";
                setTimeout(() => { msgDiv.innerText = ""; }, 3000);
            } catch (err) {
                msgDiv.style.color = "red"; msgDiv.innerText = "Erro ao gerar imagem.";
            }
        });

        // --- L√ìGICA DE DESIGNA√á√ïES S-89 / WHATSAPP ---
        const modalDesignacoes = document.getElementById('modalDesignacoes');
        
        async function gerarImagemS89(nome, ajudante, dataStr, parte, local) {
            document.getElementById('s89-nome').innerText = nome;
            document.getElementById('s89-ajudante').innerText = ajudante || '---';
            document.getElementById('s89-data').innerText = dataStr;
            document.getElementById('s89-parte').innerText = parte;
            
            // Controle visual dos checkboxes do local no S-89
            const boxes = document.querySelectorAll('.s89-box');
            boxes.forEach(b => b.classList.remove('s89-box-checked'));
            if(local === "Sala B") boxes[1].classList.add('s89-box-checked');
            else boxes[0].classList.add('s89-box-checked');

            const molde = document.getElementById('molde-s89');
            const canvas = await html2canvas(molde, { scale: 2, backgroundColor: "#ffffff" });
            return canvas.toDataURL('image/png');
        }

        document.getElementById('btnGerarDesignacoes').addEventListener('click', async () => {
            const dataReuniao = document.getElementById('dataReuniao').value;
            if (!dataReuniao) { alert("Por favor, selecione uma data da reuni√£o no formul√°rio."); return; }

            document.getElementById('tituloModalGerar').innerText = "üì± Designa√ß√µes S-89 / WhatsApp";
            modalDesignacoes.style.display = 'flex';
            document.getElementById('loadingImagens').style.display = 'block';
            document.getElementById('conteudoDesignacoes').style.display = 'none';
            
            const container = document.getElementById('listaDesignacoesProntas');
            container.innerHTML = '';
            designacoesGeradasMemoria = [];

            const dataFormatada = dataReuniao.split('-').reverse().join('/');
            let designacoes = [];
            const usarSalaB = document.getElementById('usarSalaB').checked;

            const leitura = document.getElementById('leituraBiblia').value;
            if (leitura) designacoes.push({ nome: leitura, ajudante: "", parte: "Parte 3 - Leitura da B√≠blia", local: "Sal√£o principal" });

            document.querySelectorAll('#containerMinisterio .dinamico-item').forEach((item, index) => {
                const estP = item.querySelector('.min-estudante').value;
                const ajuP = item.querySelector('.min-ajudante').value;
                if (estP) designacoes.push({ nome: estP, ajudante: ajuP, parte: `Parte ${index + 4}`, local: "Sal√£o principal" });
                
                if (usarSalaB) {
                    const estB = item.querySelector('.min-estudante-b').value;
                    const ajuB = item.querySelector('.min-ajudante-b').value;
                    if (estB) designacoes.push({ nome: estB, ajudante: ajuB, parte: `Parte ${index + 4}`, local: "Sala B" });
                }
            });

            if (designacoes.length === 0) {
                document.getElementById('loadingImagens').style.display = 'none';
                document.getElementById('conteudoDesignacoes').style.display = 'block';
                document.getElementById('btnBaixarTodasImagens').style.display = 'none';
                container.innerHTML = '<p style="text-align:center; color:#666;">Nenhuma designa√ß√£o de Leitura ou Minist√©rio preenchida.</p>';
                return;
            }

            for (const desig of designacoes) {
                const imgDataUrl = await gerarImagemS89(desig.nome, desig.ajudante, dataFormatada, desig.parte, desig.local);
                const nomeArquivoSeguro = `S89_${desig.nome.replace(/\s+/g, '_')}_${desig.parte.replace(/ /g, '')}.png`;
                
                designacoesGeradasMemoria.push({ nomeArquivo: nomeArquivoSeguro, imgBase64: imgDataUrl });

                const textoMsg = `*DESIGNA√á√ÉO PARA A REUNI√ÉO*\n\nüë§ *Nome:* ${desig.nome}\nüë• *Ajudante:* ${desig.ajudante || '---'}\nüìÖ *Data:* ${dataFormatada}\nüìù *Parte:* ${desig.parte}\nüè¢ *Local:* ${desig.local}\n\n_Veja as instru√ß√µes na Apostila._`;
                const urlWhatsApp = `https://api.whatsapp.com/send?text=${encodeURIComponent(textoMsg)}`;

                const card = document.createElement('div');
                card.className = 'designacao-card';
                card.innerHTML = `
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <img src="${imgDataUrl}" style="height: 80px; border: 1px solid #ccc; border-radius: 4px;">
                        <div>
                            <strong style="display:block; font-size: 16px; color: #333;">${desig.parte} (${desig.local})</strong>
                            <span style="display:block; font-size: 14px; margin-top: 5px;">Estudante: <b>${desig.nome}</b></span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <a href="${urlWhatsApp}" target="_blank" style="flex: 1; text-decoration: none;">
                            <button type="button" class="btn-whatsapp">üí¨ WhatsApp</button>
                        </a>
                        <button type="button" class="btn-download-img" style="flex: 1;" onclick="salvarImagemIndividual('${imgDataUrl}', '${nomeArquivoSeguro}')">üñºÔ∏è Baixar S-89</button>
                    </div>
                `;
                container.appendChild(card);
            }

            document.getElementById('loadingImagens').style.display = 'none';
            document.getElementById('conteudoDesignacoes').style.display = 'block';
            document.getElementById('btnBaixarTodasImagens').style.display = 'block';
        });

        window.salvarImagemIndividual = function(dataUrl, nomeArquivo) { saveAs(dataUrl, nomeArquivo); };

        document.getElementById('btnBaixarTodasImagens').addEventListener('click', () => {
            const dataForm = document.getElementById('dataReuniao').value.split('-').reverse().join('-');
            const zip = new JSZip();
            designacoesGeradasMemoria.forEach(desig => { zip.file(desig.nomeArquivo, desig.imgBase64.split(',')[1], {base64: true}); });
            zip.generateAsync({type:"blob"}).then(function(content) { saveAs(content, `Designacoes_${dataForm}.zip`); });
        });

        document.getElementById('fecharDesignacoes').addEventListener('click', () => { modalDesignacoes.style.display = 'none'; });
    </script>
</body>
</html>
