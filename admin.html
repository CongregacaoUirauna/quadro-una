<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Escala da Congregação</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9;}
        .section { background-color: white; border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
        h1 { color: #333; text-align: center; }
        h3 { color: #555; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 0; display: flex; justify-content: space-between; align-items: center;}
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; color: #444;}
        input { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        input[type="checkbox"] { width: auto; margin-right: 10px; transform: scale(1.2); }
        .checkbox-container { display: flex; align-items: center; background-color: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeeba; margin-top: 15px; }
        .input-group { display: flex; gap: 10px; margin-top: 5px; align-items: center;}
        .input-group input { width: 50%; }
        
        button { background-color: #4CAF50; color: white; padding: 12px 20px; border: none; cursor: pointer; font-size: 16px; margin-top: 15px; border-radius: 4px; width: 100%; font-weight: bold;}
        button:hover { background-color: #45a049; }
        
        .btn-add { background-color: #2196F3; width: auto; padding: 6px 12px; font-size: 12px; margin-top: 0; }
        .btn-add:hover { background-color: #0b7dda; }
        .btn-remove { background-color: #f44336; width: auto; padding: 10px; margin-top: 0; font-size: 14px;}
        .btn-remove:hover { background-color: #d32f2f; }
        .btn-sair { background-color: #f44336; width: auto; float: right; margin-top: 0; padding: 8px 15px;}
        .btn-sair:hover { background-color: #d32f2f; }
        
        #mensagem, #loginMensagem { margin-top: 15px; font-weight: bold; text-align: center; }
        
        #painelSistema { display: none; } 
        #telaLogin { max-width: 400px; margin: 80px auto; text-align: center; background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
        .dinamico-item { background-color: #f1f1f1; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px dashed #ccc;}
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="telaLogin">
        <h2 style="color: #333; margin-top: 0;">Acesso Restrito</h2>
        <p style="color: #666; font-size: 14px;">Insira suas credenciais para gerenciar a escala.</p>
        <input type="email" id="emailLogin" placeholder="Seu E-mail" required>
        <input type="password" id="senhaLogin" placeholder="Sua Senha" required>
        <button id="btnEntrar">Entrar no Sistema</button>
        <div id="loginMensagem"></div>
    </div>

    <div id="painelSistema">
        <button id="btnSair" class="btn-sair">Sair do Sistema</button>
        <h1>Painel de Designações Semanais</h1>
        
        <div class="section">
            <label for="dataReuniao">Data da Reunião (Identificador Único):</label>
            <input type="date" id="dataReuniao" required>
            <label for="presidente">Presidente da Reunião:</label>
            <input type="text" id="presidente" placeholder="Ex: Francisco Nunes">
            
            <div class="checkbox-container">
                <input type="checkbox" id="chkVisita">
                <label for="chkVisita" style="margin-top: 0; color: #856404;">Semana de Visita do Superintendente de Circuito</label>
            </div>
        </div>

        <div class="section">
            <h3>Abertura</h3>
            <div class="input-group">
                <input type="number" id="canticoInicial" placeholder="Nº do Cântico">
                <input type="text" id="oracaoInicial" placeholder="Oração Inicial">
            </div>
            <label for="comentariosIniciais">Comentários Iniciais (1 min):</label>
            <input type="text" id="comentariosIniciais" placeholder="Ex: Francisco Nunes">
        </div>

        <div class="section">
            <h3>Tesouros da Palavra de Deus</h3>
            <label for="parte1">Parte 1 - Discurso Principal (10 min):</label>
            <input type="text" id="parte1" placeholder="Ex: Glebston Lima">
            <label for="parte2">Parte 2 - Joias Espirituais (10 min):</label>
            <input type="text" id="parte2" placeholder="Ex: Glebston Lima">
            <label for="leituraBiblia">Parte 3 - Leitura da Bíblia (4 min):</label>
            <input type="text" id="leituraBiblia" placeholder="Ex: Rony">
        </div>

        <div class="section">
            <h3>
                Faça seu Melhor no Ministério
                <button type="button" class="btn-add" id="btnAddMinisterio">+ Adicionar Parte</button>
            </h3>
            <div id="containerMinisterio">
                </div>
        </div>

        <div class="section">
            <h3>
                Nossa Vida Cristã
                <button type="button" class="btn-add" id="btnAddVidaCrista">+ Adicionar Parte</button>
            </h3>
            <label for="canticoIntermediario">Cântico Intermediário (Número):</label>
            <input type="number" id="canticoIntermediario" placeholder="Ex: 118">

            <div id="containerVidaCrista">
                </div>

            <div id="blocoEstudo">
                <label>Estudo Bíblico de Congregação (30 min):</label>
                <div class="input-group">
                    <input type="text" id="estudoDirigente" placeholder="Dirigente">
                    <input type="text" id="estudoLeitor" placeholder="Leitor">
                </div>
            </div>

            <div id="blocoVisita" class="hidden">
                <label style="color: #856404;">Discurso do Superintendente (30 min):</label>
                <input type="text" id="discursoViajante" placeholder="Nome do Superintendente">
            </div>

            <label for="comentariosFinais">Comentários Finais (3 min):</label>
            <input type="text" id="comentariosFinais" placeholder="Ex: Francisco Nunes">

            <label>Conclusão:</label>
            <div class="input-group">
                <input type="number" id="canticoFinal" placeholder="Nº do Cântico">
                <input type="text" id="oracaoFinal" placeholder="Oração Final">
            </div>
        </div>

        <button id="btnSalvar">Salvar Programação no Banco de Dados</button>
        <div id="mensagem"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC3U8tyPk5IB_y51-3d7_6V-16qtoqzeI8",
            authDomain: "quadro-congregacao.firebaseapp.com",
            projectId: "quadro-congregacao",
            storageBucket: "quadro-congregacao.firebasestorage.app",
            messagingSenderId: "1085145636546",
            appId: "1:1085145636546:web:69d340e69f28814a1de55b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Lógica de Autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('telaLogin').style.display = 'none';
                document.getElementById('painelSistema').style.display = 'block';
            } else {
                document.getElementById('telaLogin').style.display = 'block';
                document.getElementById('painelSistema').style.display = 'none';
            }
        });

        document.getElementById('btnEntrar').addEventListener('click', async () => {
            const email = document.getElementById('emailLogin').value;
            const senha = document.getElementById('senhaLogin').value;
            const msg = document.getElementById('loginMensagem');
            msg.innerText = "Verificando...";
            msg.style.color = "#333";
            try {
                await signInWithEmailAndPassword(auth, email, senha);
                msg.innerText = ""; 
            } catch (error) {
                msg.style.color = "red";
                msg.innerText = "Erro: Verifique e-mail e senha.";
            }
        });

        document.getElementById('btnSair').addEventListener('click', () => signOut(auth));

        // Lógica de UI: Checkbox da Visita do Superintendente
        const chkVisita = document.getElementById('chkVisita');
        const blocoEstudo = document.getElementById('blocoEstudo');
        const blocoVisita = document.getElementById('blocoVisita');

        chkVisita.addEventListener('change', (e) => {
            if(e.target.checked) {
                blocoEstudo.classList.add('hidden');
                blocoVisita.classList.remove('hidden');
            } else {
                blocoEstudo.classList.remove('hidden');
                blocoVisita.classList.add('hidden');
            }
        });

        // Lógica de UI: Adicionar/Remover Partes Dinâmicas
        function criarParteMinisterio() {
            const container = document.getElementById('containerMinisterio');
            const div = document.createElement('div');
            div.className = 'dinamico-item input-group';
            div.innerHTML = `
                <input type="text" class="min-estudante" placeholder="Estudante/Designado">
                <input type="text" class="min-ajudante" placeholder="Ajudante (se houver)">
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(div);
        }

        function criarParteVidaCrista() {
            const container = document.getElementById('containerVidaCrista');
            const div = document.createElement('div');
            div.className = 'dinamico-item input-group';
            div.innerHTML = `
                <input type="text" class="vc-tempo" placeholder="Tempo (ex: 15 min)" style="width: 30%;">
                <input type="text" class="vc-designado" placeholder="Designado" style="width: 70%;">
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()">X</button>
            `;
            container.appendChild(div);
        }

        document.getElementById('btnAddMinisterio').addEventListener('click', criarParteMinisterio);
        document.getElementById('btnAddVidaCrista').addEventListener('click', criarParteVidaCrista);

        // Criar pelo menos uma parte inicial por padrão
        window.onload = () => {
            criarParteMinisterio();
            criarParteMinisterio();
            criarParteMinisterio();
            criarParteVidaCrista();
        };

        // Lógica de Salvamento
        document.getElementById('btnSalvar').addEventListener('click', async () => {
            const dataReuniao = document.getElementById('dataReuniao').value;
            const msgDiv = document.getElementById('mensagem');

            if (!dataReuniao) {
                msgDiv.style.color = "red";
                msgDiv.innerText = "ATENÇÃO: Selecione a data da reunião.";
                window.scrollTo({ top: 0, behavior: 'smooth' }); 
                return;
            }

            msgDiv.style.color = "blue";
            msgDiv.innerText = "Enviando para o banco de dados...";

            // Capturar array do Ministério
            const partesMinisterio = [];
            document.querySelectorAll('#containerMinisterio .dinamico-item').forEach(item => {
                partesMinisterio.push({
                    estudante: item.querySelector('.min-estudante').value,
                    ajudante: item.querySelector('.min-ajudante').value
                });
            });

            // Capturar array da Vida Cristã
            const partesVidaCrista = [];
            document.querySelectorAll('#containerVidaCrista .dinamico-item').forEach(item => {
                partesVidaCrista.push({
                    tempo: item.querySelector('.vc-tempo').value,
                    designado: item.querySelector('.vc-designado').value
                });
            });

            const programacaoData = {
                data: dataReuniao,
                presidente: document.getElementById('presidente').value,
                visita_superintendente: chkVisita.checked,
                abertura: {
                    cantico: document.getElementById('canticoInicial').value,
                    oracao: document.getElementById('oracaoInicial').value,
                    comentarios: document.getElementById('comentariosIniciais').value
                },
                tesouros: {
                    parte_1: document.getElementById('parte1').value,
                    parte_2: document.getElementById('parte2').value,
                    leitura: document.getElementById('leituraBiblia').value
                },
                ministerio: partesMinisterio,
                vida_crista: {
                    cantico_intermediario: document.getElementById('canticoIntermediario').value,
                    partes: partesVidaCrista,
                    estudo_dirigente: document.getElementById('estudoDirigente').value,
                    estudo_leitor: document.getElementById('estudoLeitor').value,
                    discurso_viajante: document.getElementById('discursoViajante').value,
                    comentarios_finais: document.getElementById('comentariosFinais').value,
                    cantico_final: document.getElementById('canticoFinal').value,
                    oracao_final: document.getElementById('oracaoFinal').value
                }
            };

            try {
                await setDoc(doc(db, "programacoes_semanais", dataReuniao), programacaoData);
                msgDiv.style.color = "green";
                msgDiv.innerText = "Programação salva com sucesso!";
            } catch (error) {
                console.error("Erro ao salvar: ", error);
                msgDiv.style.color = "red";
                msgDiv.innerText = "Erro ao salvar. Verifique sua conexão.";
            }
        });
    </script>
</body>
</html>
