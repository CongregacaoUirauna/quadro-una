<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Programa√ß√£o Semanal</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/print.css">
</head>
<body>

    <div id="molde-s89">
        <div class="s89-titulo">DESIGNA√á√ÉO PARA A REUNI√ÉO<br>NOSSA VIDA E MINIST√âRIO CRIST√ÉO</div>
        <div class="s89-linha"><div class="s89-label">Nome:</div><div class="s89-campo" id="s89-nome"></div></div>
        <div class="s89-linha"><div class="s89-label">Ajudante:</div><div class="s89-campo" id="s89-ajudante"></div></div>
        <div class="s89-linha"><div class="s89-label">Data:</div><div class="s89-campo" id="s89-data"></div></div>
        <div class="s89-linha"><div class="s89-label">N√∫mero da parte:</div><div class="s89-campo" id="s89-parte"></div></div>
        
        <div class="s89-local-titulo">Local:</div>
        <div class="s89-checkbox"><div class="s89-box s89-box-checked"></div> Sal√£o principal</div>
        <div class="s89-checkbox"><div class="s89-box"></div> Sala B</div>
        <div class="s89-checkbox"><div class="s89-box"></div> Sala C</div>
        
        <div class="s89-obs">
            <strong>Observa√ß√£o para o estudante:</strong> A li√ß√£o e a fonte de mat√©ria para a sua designa√ß√£o est√£o na <i>Apostila da Reuni√£o Vida e Minist√©rio</i>. Veja as instru√ß√µes para a parte que est√£o nas <i>Instru√ß√µes para a Reuni√£o Nossa Vida e Minist√©rio Crist√£o</i> (S-89).
        </div>
    </div>

    <div id="molde-s140-container"></div>

    <div id="telaLogin">
        <h2 style="color: #1a73e8; margin-top: 0;">Acesso Restrito</h2>
        <p style="color: #666; font-size: 14px;">Insira suas credenciais para gerenciar a escala.</p>
        <input type="email" id="emailLogin" placeholder="Seu E-mail" required>
        <input type="password" id="senhaLogin" placeholder="Sua Senha" required>
        <button class="btn-salvar" id="btnEntrar">Entrar no Sistema</button>
        <div id="loginMensagem"></div>
    </div>

    <div id="painelSidebar">
        <div class="sidebar-header">
            <h2>Gestor Semanal</h2>
        </div>
        <button id="btnNovaProgramacao">+ Nova Programa√ß√£o</button>
        <ul class="history-list" id="listaHistorico"></ul>
    </div>

    <div id="painelSistema">
        <div class="container">
            <div class="topo-acoes">
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" id="btnConfig" class="btn-config">‚öôÔ∏è Configura√ß√µes</button>
                    <button type="button" id="btnGerarDesignacoes" class="btn-config" style="background-color: #25D366; color: white;">üì± S-89 / WhatsApp</button>
                    <button type="button" id="btnGerarS140" class="btn-config" style="background-color: #9c27b0; color: white;">üñ®Ô∏è Gerar Quadro S-140</button>
                </div>
                <button type="button" id="btnSair" class="btn-sair">Sair do Sistema</button>
            </div>

            <div id="nav-abas-principais" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px;">
    <button id="aba-temas" class="btn-salvar" style="margin-top: 0; width: auto; background-color: #1a73e8;">üìã Temas e C√¢nticos</button>
    <button id="aba-escalas" class="btn-config" style="margin-top: 0; width: auto; background-color: #e0e0e0; color: #666;">üìÖ Tabela Mensal</button>
    
    <button id="aba-mecanicas" class="btn-config" style="margin-top: 0; width: auto; background-color: #e0e0e0; color: #666;">‚öôÔ∏è Designa√ß√µes Mec√¢nicas</button>
</div>
            
            <div id="painel-estrutural-temas">
                <h1 id="tituloAcao">Nova Programa√ß√£o</h1>
                
                <form id="formReuniao">
                    <div class="evento-destaque">
                        <label for="dataReuniao" style="margin-top: 0;">Data da Reuni√£o:</label>
                        <input type="date" id="dataReuniao" required>
                        
                        <label for="tipoEvento">Tipo de Programa√ß√£o:</label>
                        <select id="tipoEvento">
                            <option value="Normal">Reuni√£o Normal</option>
                            <option value="Visita">Visita do Superintendente de Circuito</option>
                            <option value="Assembleia">Assembleia</option>
                            <option value="Congresso">Congresso</option>
                            <option value="Celebracao">Celebra√ß√£o da Morte de Cristo</option>
                        </select>

                        <label style="display: flex; align-items: center; gap: 10px; margin-top: 15px; cursor: pointer;">
                            <input type="checkbox" id="usarSalaB" style="width: auto; margin: 0; transform: scale(1.3);">
                            <span style="color: #1a73e8; font-weight: bold;">Habilitar uso da Sala B nesta reuni√£o</span>
                        </label>
                    </div>

                    <div id="formSections">
                        <div class="section">
                            <label for="presidente" style="margin-top: 0;">Presidente da Reuni√£o e Conselheiro (Sala B):</label>
                            <div class="input-group">
                                <select id="presidente" class="lista-presidentes" style="width: 50%;"></select>
                                <select id="conselheiroSalaB" class="aprovados-ensino" style="width: 50%;"></select>
                            </div>
                            <small style="color: #666;">O Conselheiro da Sala B s√≥ ser√° impresso no quadro se a Sala B estiver habilitada acima.</small>
                        </div>

                        <div class="section">
                            <h3>Abertura</h3>
                            <div class="input-group">
                                <input type="number" id="canticoInicial" placeholder="N¬∫ do C√¢ntico Inicial" min="1" style="width: 30%;">
                                <select id="oracaoInicial" class="lista-oracao" style="width: 70%;"></select>
                            </div>
                            <label for="comentariosIniciais">Coment√°rios Iniciais (1 min):</label>
                            <input type="text" id="comentariosIniciais" readonly style="background-color: #e9ecef;">
                        </div>

                        <div class="section">
                            <h3>Tesouros da Palavra de Deus</h3>
                            
                            <label style="color: #45818e;">Leitura Semanal da B√≠blia (Congrega√ß√£o):</label>
                            <input type="text" id="leituraSemanal" placeholder="Ex: ISA√çAS 38-40" style="margin-bottom: 15px; border-color: #45818e; font-weight: bold;">
                            
                            <label>Parte 1 - Discurso Principal (10 min):</label>
                            <div class="input-group">
                                <input type="text" id="temaParte1" placeholder="Tema do Discurso" style="width: 60%;">
                                <select id="parte1" class="aprovados-ensino" style="width: 40%;"></select>
                            </div>
                            
                            <label>Parte 2 - Joias Espirituais (10 min):</label>
                            <div class="input-group">
                                <input type="text" id="temaParte2" placeholder="Tema das Joias" style="width: 60%;">
                                <select id="parte2" class="aprovados-ensino" style="width: 40%;"></select>
                            </div>
                            
                            <label>Parte 3 - Leitura da B√≠blia (Estudante - 4 min):</label>
                            <div class="input-group">
                                <input type="text" id="trechoLeitura" placeholder="Ex: Isa. 40:21-31 (th li√ß√£o 11)" style="width: 60%;">
                                <select id="leituraBiblia" class="lista-irmaos" style="width: 40%;"></select>
                            </div>
                        </div>

                        <div class="section">
                            <h3>
                                Fa√ßa seu Melhor no Minist√©rio
                                <button type="button" class="btn-add" id="btnAddMinisterio">+ Adicionar Parte</button>
                            </h3>
                            <div id="containerMinisterio"></div>
                        </div>

                        <div class="section">
                            <h3>
                                Nossa Vida Crist√£
                                <button type="button" class="btn-add" id="btnAddVidaCrista">+ Adicionar Parte</button>
                            </h3>
                            <label for="canticoIntermediario">C√¢ntico Intermedi√°rio:</label>
                            <input type="number" id="canticoIntermediario" placeholder="N¬∫ do C√¢ntico" min="1">

                            <div id="containerVidaCrista"></div>

                            <div id="blocoEstudo">
                                <label>Estudo B√≠blico de Congrega√ß√£o (30 min):</label>
                                <div class="input-group">
                                    <select id="estudoDirigente" class="aprovados-ensino"></select>
                                    <select id="estudoLeitor" class="lista-leitores"></select>
                                </div>
                            </div>

                            <div id="blocoVisita" class="hidden">
                                <label style="color: #1a73e8;">Discurso do Superintendente (30 min):</label>
                                <input type="text" id="discursoViajante" placeholder="Nome do Superintendente">
                            </div>

                            <label for="comentariosFinais">Coment√°rios Finais (3 min):</label>
                            <input type="text" id="comentariosFinais" readonly style="background-color: #e9ecef;">

                            <label>Conclus√£o:</label>
                            <div class="input-group">
                                <input type="number" id="canticoFinal" placeholder="N¬∫ do C√¢ntico Final" min="1" style="width: 30%;">
                                <select id="oracaoFinal" class="lista-oracao" style="width: 70%;"></select>
                            </div>
                        </div>
                    </div> 

                    <button type="button" class="btn-salvar" id="btnSalvar">Salvar Programa√ß√£o</button>
                    <div id="mensagem"></div>
                </form>
            </div>

            <div id="painel-escala-abas" class="hidden">
    <div class="container-escala">
        <div class="escala-header" style="display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #ddd;">
            <div>
                <label for="mesReferencia" style="margin: 0; font-weight: bold; color: #1a73e8;">M√™s de Programa√ß√£o:</label>
                <input type="month" id="mesReferencia" class="btn-config" style="background: white; border: 1px solid #ccc; width: auto; margin-left: 10px;">
            </div>
            <div id="status-salvamento-mensal" style="font-weight: bold; font-size: 14px;"></div>
        </div>

        <div class="sub-nav" style="display: flex; gap: 5px; margin-bottom: -1px;">
            <button id="sub-aba-estudantes" class="tab-active" style="padding: 10px 20px; border: 1px solid #ddd; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; background: #fff; font-weight: bold; color: #1a73e8;">üìñ Designa√ß√µes de Estudantes</button>
            <button id="sub-aba-geral" style="padding: 10px 20px; border: 1px solid #ddd; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; background: #f1f1f1; color: #666;">üèõÔ∏è Reuni√£o Geral</button>
        </div>

        <div class="tab-content" style="border: 1px solid #ddd; padding: 20px; border-radius: 0 0 8px 8px; background: #fff;">
            
            <div id="container-tab-estudantes">
                <div class="table-responsive">
                    <table class="tabela-mensal" id="tabela-estudantes" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #e3f2fd; color: #1a73e8;">
                                <th style="padding: 12px; border: 1px solid #ddd; width: 15%;">Data</th>
                                <th style="padding: 12px; border: 1px solid #ddd; width: 25%;">Leitura B√≠blica</th>
                                <th style="padding: 12px; border: 1px solid #ddd;">Partes do Minist√©rio (Titular / Ajudante)</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-estudantes">
                            </tbody>
                    </table>
                </div>
                <button type="button" id="btnSalvarEstudantesMensal" class="btn-salvar" style="margin-top: 20px; background-color: #1a73e8;">üíæ Salvar Estudantes do M√™s</button>
            </div>

            <div id="container-tab-geral" class="hidden">
                <div class="table-responsive">
                    <table class="tabela-mensal" id="tabela-geral" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f3e5f5; color: #9c27b0;">
                                <th style="padding: 12px; border: 1px solid #ddd; width: 15%;">Data</th>
                                <th style="padding: 12px; border: 1px solid #ddd; width: 40%;">Tesouros e Abertura</th>
                                <th style="padding: 12px; border: 1px solid #ddd; width: 45%;">Nossa Vida Crist√£</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-geral">
                            </tbody>
                    </table>
                </div>
                <button type="button" id="btnSalvarGeralMensal" class="btn-salvar" style="margin-top: 20px; background-color: #9c27b0;">üíæ Salvar Reuni√£o Geral do M√™s</button>
            </div>

        </div>
    </div>
</div>
            <div id="painel-mecanicas" class="hidden">
    <div class="container-escala">
        <div class="escala-header" style="display: flex; justify-content: space-between; align-items: center; background: #e0f2f1; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #b2dfdb;">
            <div>
                <label for="mesMecanica" style="margin: 0; font-weight: bold; color: #00695c;">M√™s de Refer√™ncia:</label>
                <input type="month" id="mesMecanica" class="btn-config" style="background: white; border: 1px solid #ccc; width: auto; margin-left: 10px;">
            </div>
            <div>
                <button type="button" id="btnImprimirMecanicas" class="btn-config" style="background-color: #17a2b8; color: white; margin-top: 0; margin-right: 5px;">üñ®Ô∏è Imprimir</button>
                <button type="button" id="btnSugerirEscalaMecanica" class="btn-salvar" style="background-color: #fbbc05; color: #333; margin-top: 0; margin-right: 10px;">ü§ñ Sugerir Escala do M√™s</button>
                <span id="status-mecanica" style="font-weight: bold; font-size: 14px; color: #00695c;"></span>
            </div>
        </div>

        <div class="table-responsive">
            <table class="tabela-mensal" id="tabela-mecanicas" style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #2a6b77; color: white;">
                        <th style="padding: 10px; border: 1px solid #ddd; width: 10%;">Data</th>
                        <th style="padding: 10px; border: 1px solid #ddd; background-color: #1e4d56;">Qui (Ind)</th>
                        <th style="padding: 10px; border: 1px solid #ddd; background-color: #1e4d56;">Qui (Vol)</th>
                        <th style="padding: 10px; border: 1px solid #ddd; background-color: #1e4d56;">Qui (Som)</th>
                        <th style="padding: 10px; border: 1px solid #ddd; background-color: #a36d00;">Dom (Ind)</th>
                        <th style="padding: 10px; border: 1px solid #ddd; background-color: #a36d00;">Dom (Vol)</th>
                        <th style="padding: 10px; border: 1px solid #ddd; background-color: #a36d00;">Dom (Som)</th>
                        <th style="padding: 10px; border: 1px solid #ddd; background-color: #a36d00;">Dom (Pres)</th>
                        <th style="padding: 10px; border: 1px solid #ddd; background-color: #a36d00;">Dom (Leit)</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela-mecanicas">
                    </tbody>
            </table>
        </div>
        <button type="button" id="btnSalvarMecanicas" class="btn-salvar" style="margin-top: 20px; background-color: #2a6b77;">üíæ Salvar Designa√ß√µes Mec√¢nicas</button>
    </div>
</div>
        </div>
    </div>

    <div id="modalConfig" class="modal-bg">
        <div class="modal-content">
            <span class="modal-close" id="fecharConfig">&times;</span>
            <h2 style="color: #1a73e8; margin-top: 0;">Configura√ß√µes e Listas</h2>
            
            <div class="section" style="padding: 15px; margin-bottom: 10px;">
                <label for="configNomeCongregacao" style="margin-top:0;">Nome da Congrega√ß√£o (Para o S-140):</label>
                <input type="text" id="configNomeCongregacao" placeholder="Ex: CONGREGA√á√ÉO CENTRO">
                
                <label for="configDiaReuniao">Dia da Reuni√£o na Semana:</label>
                <select id="configDiaReuniao">
                    <option value="1">Segunda-feira</option>
                    <option value="2">Ter√ßa-feira</option>
                    <option value="3">Quarta-feira</option>
                    <option value="4">Quinta-feira</option>
                    <option value="5">Sexta-feira</option>
                    <option value="6">S√°bado</option>
                    <option value="0">Domingo</option>
                </select>
            </div>

            <div class="config-grid">
                <div class="lista-manager">
                    <label style="margin-top:0;">Selecione a Lista para Gerenciar:</label>
                        <select id="tipoListaEdicao">
                            <option value="irmaos">Irm√£os (Leitura e Geral)</option>
                            <option value="irmas">Irm√£s (Geral)</option>
                            <option value="presidentes">Aprovados para Presidente</option>
                            <option value="aprovados_ensino">Aprovados para Discursos/Ensino</option>
                            <option value="leitores_estudo">Aprovados para Leitor do Estudo</option>
                            <option value="aprovados_oracao">Aprovados para Ora√ß√£o</option>
                            
                            <option value="mec_som">Mec√¢nica: Aprovados para o Som</option>
                            <option value="mec_volante">Mec√¢nica: Aprovados para Volante</option>
                            <option value="mec_indicador">Mec√¢nica: Aprovados para Indicador</option>
                            <option value="mec_leitor">Mec√¢nica: Leitor de A Sentinela (Domingo)</option>
                            <option value="mec_presidente">Mec√¢nica: Presidente da Reuni√£o (Domingo)</option>
                        </select>
                    
                    <select id="listaItensAtuais" multiple></select>
                    <button type="button" class="btn-remove" id="btnRemoverNome" style="width: 100%; margin-bottom: 10px;">Remover Selecionado</button>
                    
                    <div class="input-group">
                        <input type="text" id="novoNome" placeholder="Adicionar novo nome...">
                        <button type="button" class="btn-add" id="btnAdicionarNome" style="padding: 10px;">Adicionar</button>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn-salvar" id="btnSalvarConfig">Salvar Configura√ß√µes</button>
            <div id="msgConfig" style="text-align: center; margin-top: 10px; font-weight: bold;"></div>
        </div>
    </div>

    <div id="modalDesignacoes" class="modal-bg">
        <div class="modal-content">
            <span class="modal-close" id="fecharDesignacoes">&times;</span>
            <h2 style="color: #25D366; margin-top: 0;" id="tituloModalGerar">üì± Designa√ß√µes Geradas</h2>
            
            <div id="loadingImagens" style="text-align: center; padding: 20px; font-weight: bold; color: #1a73e8; display: none;">
                ‚è≥ Processando, por favor aguarde...
            </div>

            <div id="conteudoDesignacoes">
                <button type="button" id="btnBaixarTodasImagens" class="btn-salvar" style="background-color: #fbbc05; color: #333; margin-top: 0; margin-bottom: 20px; display: none;">
                    üì¶ Baixar TODAS as Imagens (Arquivo ZIP)
                </button>
                <div id="listaDesignacoesProntas" style="max-height: 50vh; overflow-y: auto; padding-right: 10px;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        // Nossas importa√ß√µes modulares
        import { auth } from './js/firebase-config.js';
        import { carregarConfiguracoes, carregarHistoricoSidebar } from './js/estado-global.js';
        import { initMotorPDF } from './js/motor-pdf.js';
        import { initModuloTemas, prepararNovoFormulario, carregarProgramacaoEdicao } from './js/modulo-temas.js';
        import { initModuloMecanicas } from './js/modulo-mecanicas.js';
        
        // --- GERENCIAMENTO DE ESTADO DE AUTENTICA√á√ÉO ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('telaLogin').style.display = 'none';
                document.getElementById('painelSidebar').style.display = 'flex';
                document.getElementById('painelSistema').style.display = 'block';
                
                // Inicializa os dados
                await carregarConfiguracoes();
                
                // Passamos os callbacks para a Sidebar interagir com o form sem se acoplarem fortemente
                carregarHistoricoSidebar(carregarProgramacaoEdicao, prepararNovoFormulario);
                
                // Prepara a interface
                prepararNovoFormulario();
                initMotorPDF();
                initModuloTemas();
                initModuloMecanicas();
                
            } else {
                document.getElementById('telaLogin').style.display = 'block';
                document.getElementById('painelSidebar').style.display = 'none';
                document.getElementById('painelSistema').style.display = 'none';
            }
        });

        // --- FLUXO DE LOGIN/LOGOUT ---
        document.getElementById('btnEntrar').addEventListener('click', async () => {
            const email = document.getElementById('emailLogin').value;
            const senha = document.getElementById('senhaLogin').value;
            const msg = document.getElementById('loginMensagem');
            msg.innerText = "Acessando...";
            msg.style.color = "#333";
            try { 
                await signInWithEmailAndPassword(auth, email, senha); 
            } catch (error) { 
                msg.innerText = "Erro: Verifique e-mail e senha."; 
                msg.style.color = "red"; 
            }
        });

        document.getElementById('btnSair').addEventListener('click', () => signOut(auth));

       // --- CONTROLE DE NAVEGA√á√ÉO ENTRE ABAS (TEMAS VS ESCALAS) ---
        const btnAbaTemas = document.getElementById('aba-temas');
        const btnAbaEscalas = document.getElementById('aba-escalas');
        const painelTemas = document.getElementById('painel-estrutural-temas');
        const painelEscalas = document.getElementById('painel-escala-abas');

        // ABA 1: Temas e C√¢nticos (Com Auto-Sincroniza√ß√£o do L√°pis)
        btnAbaTemas.addEventListener('click', () => {
            painelTemas.classList.remove('hidden');
            painelEscalas.classList.add('hidden');
            document.getElementById('painel-mecanicas').classList.add('hidden'); // üü¢ TRAVA ADICIONADA
            
            btnAbaTemas.style.backgroundColor = '#1a73e8';
            btnAbaTemas.style.color = '#fff';
            btnAbaEscalas.style.backgroundColor = '#e0e0e0';
            btnAbaEscalas.style.color = '#666';
            document.getElementById('aba-mecanicas').style.backgroundColor = '#e0e0e0';
            document.getElementById('aba-mecanicas').style.color = '#666';

            const dataAtual = document.getElementById('dataReuniao').value;
            if (dataAtual) {
                const itensHistorico = document.querySelectorAll('#listaHistorico .history-item');
                itensHistorico.forEach(li => {
                    const span = li.querySelector('span');
                    if (span) {
                        const dataConvertida = span.innerText.split('/').reverse().join('-');
                        if (dataConvertida === dataAtual) span.click(); 
                    }
                });
            }
        });

        // ABA 2: Tabela Mensal
        btnAbaEscalas.addEventListener('click', () => {
            painelEscalas.classList.remove('hidden');
            painelTemas.classList.add('hidden');
            document.getElementById('painel-mecanicas').classList.add('hidden'); // üü¢ TRAVA ADICIONADA
            
            btnAbaEscalas.style.backgroundColor = '#1a73e8';
            btnAbaEscalas.style.color = '#fff';
            btnAbaTemas.style.backgroundColor = '#e0e0e0';
            btnAbaTemas.style.color = '#666';
            document.getElementById('aba-mecanicas').style.backgroundColor = '#e0e0e0';
            document.getElementById('aba-mecanicas').style.color = '#666';
        });
        
    </script>
</body>
</html>
