<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quadro de An√∫ncios - Congrega√ß√£o</title>
    <style>
        :root {
            --cor-tesouros: #45818e;
            --cor-ministerio: #d89b00;
            --cor-vidacrista: #990000;
            --cor-fundo: #f0f2f5;
            --cor-texto: #333;
            --cor-texto-secundario: #666;
            --cor-destaque: #1a73e8;
        }

        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: var(--cor-fundo); color: var(--cor-texto); }
        
        /* Cabe√ßalho e Controles */
        .header { background-color: #fff; padding: 15px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; position: sticky; top: 0; z-index: 100;}
        .header h1 { margin: 0; font-size: 20px; color: var(--cor-texto); font-weight: 600; }
        
        .controles-topo { max-width: 600px; margin: 15px auto 0 auto; display: flex; flex-direction: column; gap: 10px;}
        
        .seletor-data select { width: 100%; padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px; background-color: #f8f9fa; outline: none; font-weight: bold; color: var(--cor-texto); cursor: pointer; box-sizing: border-box;}
        
        .busca-container { position: relative; width: 100%; }
        .busca-container input { width: 100%; padding: 10px 15px 10px 35px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px; outline: none; box-sizing: border-box; transition: border-color 0.3s;}
        .busca-container input:focus { border-color: var(--cor-destaque); box-shadow: 0 0 0 2px rgba(26,115,232,0.2);}
        .busca-icone { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 16px; color: #999; }

        /* Container Principal */
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        
        /* Cart√£o da Programa√ß√£o */
        .card { background-color: #fff; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 30px; border: 1px solid #eaeaea; }
        
        /* Cabe√ßalho do Cart√£o */
        .card-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: flex-start; }
        .data-badge { background-color: var(--cor-vidacrista); color: white; padding: 5px 15px; border-radius: 15px; font-weight: bold; font-size: 14px; display: inline-block; margin-bottom: 10px;}
        .presidente-info { text-align: right; font-size: 14px; color: var(--cor-texto-secundario); }
        .presidente-info strong { color: var(--cor-texto); display: block; font-size: 15px;}

        /* Lista e Itens Gerais */
        .section-content { padding: 0 20px 20px 20px; }
        .item-linha { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 14.5px; align-items: center;}
        .item-linha:last-child { border-bottom: none; }
        .item-titulo { color: var(--cor-texto-secundario); flex: 1; padding-right: 15px;}
        .item-nome { font-weight: 600; color: var(--cor-texto); text-align: right; }
        .item-duplo { display: flex; flex-direction: column; align-items: flex-end;}
        .item-duplo span { font-size: 12px; color: var(--cor-texto-secundario); font-weight: normal; margin-top: 2px;}

        /* T√≠tulos das Se√ß√µes */
        .titulo-secao { font-size: 16px; font-weight: bold; margin: 20px 0 10px 0; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px;}
        .titulo-tesouros { color: var(--cor-tesouros); }
        .titulo-ministerio { color: var(--cor-ministerio); }
        .titulo-vidacrista { color: var(--cor-vidacrista); }
        
        /* Blocos de C√¢nticos (Destaque sutil) */
        .bloco-cantico { background-color: #f8f9fa; padding: 12px; border-radius: 6px; margin: 10px 0; font-size: 14px; display: flex; justify-content: space-between; align-items: center;}
        
        /* Eventos Especiais */
        .evento-especial { text-align: center; padding: 40px 20px; }
        .evento-especial h2 { color: var(--cor-tesouros); margin-bottom: 10px;}
        .evento-especial p { color: var(--cor-texto-secundario); font-size: 16px; line-height: 1.5;}
        
        /* Resultados de Pesquisa */
        #painelBusca { background-color: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        .resultado-item { border-bottom: 1px solid #eee; padding: 15px 0; }
        .resultado-item:last-child { border-bottom: none; padding-bottom: 0;}
        .resultado-lista { margin: 10px 0 0 0; padding-left: 20px; color: var(--cor-texto); font-size: 15px; line-height: 1.6;}
        
        /* Utilit√°rios */
        #loading { text-align: center; padding: 50px; color: var(--cor-texto-secundario); font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header class="header">
        <h1>Quadro de An√∫ncios</h1>
        <div class="controles-topo">
            <div class="busca-container">
                <span class="busca-icone">üîç</span>
                <input type="text" id="inputBuscaNome" placeholder="Digite seu nome para buscar suas designa√ß√µes..." autocomplete="off">
            </div>
            <div class="seletor-data" id="containerSeletor">
                <select id="selectDatas">
                    <option value="">Carregando semanas...</option>
                </select>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="loading">Buscando programa√ß√£o...</div>
        
        <div id="board" class="hidden">
            </div>

        <div id="painelBusca" class="hidden">
            <h3 style="margin-top: 0; color: var(--cor-destaque); border-bottom: 2px solid #eee; padding-bottom: 10px;" id="tituloBusca">Resultados:</h3>
            <div id="conteudoBusca"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { collection, getDocs, query, orderBy, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC3U8tyPk5IB_y51-3d7_6V-16qtoqzeI8",
            authDomain: "quadro-congregacao.firebaseapp.com",
            projectId: "quadro-congregacao",
            storageBucket: "quadro-congregacao.firebasestorage.app",
            messagingSenderId: "1085145636546",
            appId: "1:1085145636546:web:69d340e69f28814a1de55b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let todasAsProgramacoes = {};
        let datasOrdenadas = [];

        async function carregarDados() {
            try {
                
                // --- NOVA INJE√á√ÉO: Janela de Tempo Din√¢mica (Quadro de An√∫ncios) ---
        const dataLimite = new Date();
        dataLimite.setDate(dataLimite.getDate() - 45);
        const dataCorte = dataLimite.toISOString().split('T')[0]; 

        // Busca apenas as reuni√µes recentes e futuras
        const q = query(
            collection(db, "programacoes_semanais"),
            where("data", ">=", dataCorte),
            orderBy("data", "desc")
        );
        const querySnapshot = await getDocs(q);
        // -------------------------------------------------------------------
                
                querySnapshot.forEach((doc) => {
                    todasAsProgramacoes[doc.id] = doc.data();
                    datasOrdenadas.push(doc.id);
                });

                if (datasOrdenadas.length === 0) {
                    document.getElementById('loading').innerHTML = "Nenhuma programa√ß√£o dispon√≠vel no momento.";
                    return;
                }

                datasOrdenadas.sort(); // Antigas para mais novas
                
                const select = document.getElementById('selectDatas');
                select.innerHTML = '';
                
                let dataParaSelecionar = datasOrdenadas[0];
                const hojeStr = new Date().toISOString().split('T')[0];

                for (let i = 0; i < datasOrdenadas.length; i++) {
                    const dataObj = new Date(datasOrdenadas[i] + "T23:59:59");
                    if (dataObj >= new Date() || datasOrdenadas[i] === hojeStr) {
                        dataParaSelecionar = datasOrdenadas[i];
                        break;
                    }
                    dataParaSelecionar = datasOrdenadas[i]; 
                }

                // Inverte para exibir mais novas no topo do select
                [...datasOrdenadas].reverse().forEach(dataId => { 
                    const opt = document.createElement('option');
                    opt.value = dataId;
                    opt.innerText = formatarDataBR(dataId);
                    if (dataId === dataParaSelecionar) opt.selected = true;
                    select.appendChild(opt);
                });

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('board').classList.remove('hidden');
                
                renderizarProgramacao(todasAsProgramacoes[dataParaSelecionar]);

            } catch (error) {
                console.error("Erro ao carregar dados", error);
                document.getElementById('loading').innerHTML = "Erro ao carregar a programa√ß√£o. Tente novamente mais tarde.";
            }
        }

        // Eventos
        document.getElementById('selectDatas').addEventListener('change', (e) => {
            renderizarProgramacao(todasAsProgramacoes[e.target.value]);
            document.getElementById('inputBuscaNome').value = ''; // Limpa a busca ao trocar de data manualmente
            restaurarQuadroNormal();
        });

        // L√ìGICA DE BUSCA INTELIGENTE (AGORA COM IGNORADOR DE ACENTOS)
        document.getElementById('inputBuscaNome').addEventListener('input', (e) => {
            // Fun√ß√£o que tira acentos e joga tudo para min√∫sculo
            const normalizar = (str) => str ? str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
            
            const termo = normalizar(e.target.value.trim());
            const board = document.getElementById('board');
            const painelBusca = document.getElementById('painelBusca');
            const conteudoBusca = document.getElementById('conteudoBusca');
            const containerSeletor = document.getElementById('containerSeletor');

            if (termo.length < 3) {
                restaurarQuadroNormal();
                return;
            }

            board.classList.add('hidden');
            containerSeletor.classList.add('hidden');
            painelBusca.classList.remove('hidden');
            document.getElementById('tituloBusca').innerText = `Procurando por "${e.target.value}"...`;

            let encontrouAlgo = false;
            let htmlResultados = '';

            datasOrdenadas.forEach(data => {
                const p = todasAsProgramacoes[data];
                if (["Assembleia", "Congresso", "Celebracao"].includes(p.tipo_evento)) return;

                let partesEncontradas = [];

                // Agora o checar compara a vers√£o sem acentos
                const checar = (nomeSalvo, nomeParte) => {
                    if (normalizar(nomeSalvo).includes(termo)) {
                        partesEncontradas.push(nomeParte);
                    }
                };

                // Vasculhando cada canto da programa√ß√£o
                checar(p.presidente, "Presidente da Reuni√£o");
                checar(p.abertura?.oracao, "Ora√ß√£o Inicial");
                checar(p.abertura?.comentarios, "Coment√°rios Iniciais");
                checar(p.tesouros?.parte_1, "Discurso Principal");
                checar(p.tesouros?.parte_2, "Joias Espirituais");
                checar(p.tesouros?.leitura, "Leitura da B√≠blia");

               if (p.ministerio) {
                    p.ministerio.forEach((m, i) => {
                        checar(m.estudante, `Minist√©rio - Parte ${i + 4} (Sal√£o Principal)`);
                        checar(m.ajudante, `Minist√©rio - Parte ${i + 4} (Ajudante - Principal)`);
                        // Nova verifica√ß√£o para a Sala B
                        if (p.usar_sala_b) {
                            checar(m.estudante_b, `Minist√©rio - Parte ${i + 4} (Sala B)`);
                            checar(m.ajudante_b, `Minist√©rio - Parte ${i + 4} (Ajudante - Sala B)`);
                        }
                    });
                }
                
                if (p.vida_crista?.partes) {
                    p.vida_crista.partes.forEach((vc, i) => {
                        checar(vc.designado, `Vida Crist√£ - Parte ${i + 7}`);
                    });
                }

                checar(p.vida_crista?.estudo_dirigente, "Dirigente do Estudo de Congrega√ß√£o");
                checar(p.vida_crista?.estudo_leitor, "Leitor do Estudo de Congrega√ß√£o");
                checar(p.vida_crista?.discurso_viajante, "Discurso do Superintendente");
                checar(p.vida_crista?.comentarios_finais, "Coment√°rios Finais");
                checar(p.vida_crista?.oracao_final, "Ora√ß√£o Final");

                // Se achou o irm√£o nesta data, monta o bloco dele
                if (partesEncontradas.length > 0) {
                    encontrouAlgo = true;
                    htmlResultados += `
                        <div class="resultado-item">
                            <div class="data-badge">${formatarDataBR(data)}</div>
                            <ul class="resultado-lista">
                                ${partesEncontradas.map(parte => `<li><strong>${parte}</strong></li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            });

            if (encontrouAlgo) {
                document.getElementById('tituloBusca').innerText = `Designa√ß√µes para "${e.target.value}":`;
                conteudoBusca.innerHTML = htmlResultados;
            } else {
                conteudoBusca.innerHTML = `<p style="color: var(--cor-texto-secundario); text-align: center; padding: 20px 0;">Nenhuma designa√ß√£o encontrada para este nome nas programa√ß√µes atuais.</p>`;
            }
        });

        function restaurarQuadroNormal() {
            document.getElementById('painelBusca').classList.add('hidden');
            document.getElementById('board').classList.remove('hidden');
            document.getElementById('containerSeletor').classList.remove('hidden');
        }

        // Fun√ß√µes de formata√ß√£o e renderiza√ß√£o do quadro normal
        function formatarDataBR(dataISO) { return dataISO.split('-').reverse().join('/'); }

        function nomeFormatado(nome) { return nome && nome.trim() !== "" ? nome : "<span style='color:#ccc; font-weight:normal;'>A designar</span>"; }

        function renderizarProgramacao(dados) {
            const board = document.getElementById('board');
            
            if (["Assembleia", "Congresso", "Celebracao"].includes(dados.tipo_evento)) {
                let tituloEvento = dados.tipo_evento === "Celebracao" ? "Celebra√ß√£o da Morte de Cristo" : dados.tipo_evento;
                board.innerHTML = `
                    <div class="card">
                        <div class="evento-especial">
                            <div class="data-badge">${formatarDataBR(dados.data)}</div>
                            <h2>${tituloEvento}</h2>
                            <p>Nesta semana n√£o teremos a nossa Reuni√£o Vida e Minist√©rio devido a este evento especial.</p>
                        </div>
                    </div>
                `;
                return;
            }

            const isVisita = dados.tipo_evento === "Visita";
            
            // O MOTOR DE NUMERA√á√ÉO INTELIGENTE
            let proxParteNum = 4; // O Minist√©rio sempre come√ßa na parte 4
            
            let htmlMinisterio = '';
            if (dados.ministerio && dados.ministerio.length > 0) {
                dados.ministerio.forEach((parte) => {
                    const numParte = proxParteNum++; // Grava o n√∫mero atual e j√° soma +1 pra pr√≥xima
                    
                    // Bloco do Sal√£o Principal
                    htmlMinisterio += `
                        <div class="item-linha">
                            <div class="item-titulo">Parte ${numParte} ${parte.tempo ? `(${parte.tempo} min)` : ''} ${dados.usar_sala_b ? '<br><small style="color:var(--cor-destaque);">Principal</small>' : ''}</div>
                            <div class="item-duplo">
                                <div class="item-nome">${nomeFormatado(parte.estudante)}</div>
                                ${parte.ajudante ? `<span>Aj: ${parte.ajudante}</span>` : ''}
                            </div>
                        </div>
                    `;
                    
                    // Bloco da Sala B (s√≥ aparece se estiver habilitada e se tiver nomes)
                    if (dados.usar_sala_b && (parte.estudante_b || parte.ajudante_b)) {
                        htmlMinisterio += `
                            <div class="item-linha" style="background-color: #f8f9fa;">
                                <div class="item-titulo">Parte ${numParte} ${parte.tempo ? `(${parte.tempo} min)` : ''} <br><small style="color:var(--cor-ministerio);">Sala B</small></div>
                                <div class="item-duplo">
                                    <div class="item-nome">${nomeFormatado(parte.estudante_b)}</div>
                                    ${parte.ajudante_b ? `<span>Aj: ${parte.ajudante_b}</span>` : ''}
                                </div>
                            </div>
                        `;
                    }
                });
            } else { htmlMinisterio = `<div class="item-linha"><div class="item-titulo">Sem designa√ß√µes cadastradas</div></div>`; }

            let htmlVidaCrista = '';
            if (dados.vida_crista && dados.vida_crista.partes && dados.vida_crista.partes.length > 0) {
                dados.vida_crista.partes.forEach((parte) => {
                    const numParte = proxParteNum++; // Continua a numera√ß√£o exatamente de onde o Minist√©rio parou!
                    htmlVidaCrista += `
                        <div class="item-linha">
                            <div class="item-titulo">Parte ${numParte} ${parte.tempo ? `(${parte.tempo} min)` : ''}</div>
                            <div class="item-nome">${nomeFormatado(parte.designado)}</div>
                        </div>
                    `;
                });
            }

            let htmlBlocoFinal = '';
            if (isVisita) {
                htmlBlocoFinal = `
                    <div class="item-linha" style="background-color: #f0f7ff; padding: 10px; border-radius: 6px;">
                        <div class="item-titulo" style="color: #1a73e8; font-weight: bold;">Discurso do Superintendente (30 min)</div>
                        <div class="item-nome">${nomeFormatado(dados.vida_crista?.discurso_viajante)}</div>
                    </div>
                `;
            } else {
                htmlBlocoFinal = `
                    <div class="item-linha">
                        <div class="item-titulo">Estudo B√≠blico de Congrega√ß√£o (30 min)</div>
                        <div class="item-duplo">
                            <div class="item-nome">${nomeFormatado(dados.vida_crista?.estudo_dirigente)}</div>
                            <span>Leitor: ${nomeFormatado(dados.vida_crista?.estudo_leitor)}</span>
                        </div>
                    </div>
                `;
            }

            board.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="data-badge">${formatarDataBR(dados.data)}</div>
                            <div style="font-size: 13px; color: var(--cor-texto-secundario); margin-top: 5px; font-weight: bold;">
                                üìñ ${dados.tesouros?.leitura_semanal || '---'}
                            </div>
                            ${isVisita ? `<div style="color: #d89b00; font-size: 13px; font-weight: bold; margin-top: 5px;">Visita do Superintendente</div>` : ''}
                        </div>
                        <div class="presidente-info">
                            Presidente:
                            <strong>${nomeFormatado(dados.presidente)}</strong>
                        </div>
                    </div>
                    
                    <div class="section-content">
                        <div class="bloco-cantico">
                            <span>üéµ C√¢ntico ${dados.abertura?.cantico || '--'} e Ora√ß√£o</span>
                            <strong>${nomeFormatado(dados.abertura?.oracao)}</strong>
                        </div>
                        <div class="item-linha">
                            <div class="item-titulo">Coment√°rios Iniciais (1 min)</div>
                            <div class="item-nome">${nomeFormatado(dados.abertura?.comentarios)}</div>
                        </div>

                        <div class="titulo-secao titulo-tesouros">üíé Tesouros da Palavra de Deus</div>
                        <div class="item-linha">
                            <div class="item-titulo">Parte 1 - Discurso Principal (10 min)</div>
                            <div class="item-nome">${nomeFormatado(dados.tesouros?.parte_1)}</div>
                        </div>
                        <div class="item-linha">
                            <div class="item-titulo">Parte 2 - Joias Espirituais (10 min)</div>
                            <div class="item-nome">${nomeFormatado(dados.tesouros?.parte_2)}</div>
                        </div>
                        <div class="item-linha">
                            <div class="item-titulo">Parte 3 - Leitura da B√≠blia (4 min)</div>
                            <div class="item-nome">${nomeFormatado(dados.tesouros?.leitura)}</div>
                        </div>

                        <div class="titulo-secao titulo-ministerio">üåæ Fa√ßa seu Melhor no Minist√©rio</div>
                        ${htmlMinisterio}

                        <div class="titulo-secao titulo-vidacrista">üêë Nossa Vida Crist√£</div>
                        <div class="bloco-cantico" style="margin-top: 0;">
                            <span>üéµ C√¢ntico Intermedi√°rio</span>
                            <strong>N¬∫ ${dados.vida_crista?.cantico_intermediario || '--'}</strong>
                        </div>
                        
                        ${htmlVidaCrista}
                        ${htmlBlocoFinal}

                        <div class="item-linha">
                            <div class="item-titulo">Coment√°rios Finais (3 min)</div>
                            <div class="item-nome">${nomeFormatado(dados.vida_crista?.comentarios_finais)}</div>
                        </div>
                        <div class="bloco-cantico" style="margin-bottom: 0;">
                            <span>üéµ C√¢ntico ${dados.vida_crista?.cantico_final || '--'} e Ora√ß√£o</span>
                            <strong>${nomeFormatado(dados.vida_crista?.oracao_final)}</strong>
                        </div>
                    </div>
                </div>
            `;
        }

        window.onload = carregarDados;
    </script>
</body>
</html>
